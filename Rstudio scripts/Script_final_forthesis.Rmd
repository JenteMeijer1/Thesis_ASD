---
title: "Subtyping autism and normative model of CT "
author: "J. Meijer"
date: "23/05/2023"
output:
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
    keep_md: no
  html_notebook:
    toc: yes
    toc_depth: 4
    toc_float: yes
    theme: cosmo
    number_selection: true
editor_options: 
  markdown: 
    wrap: 72
---

Some common notes that should be considered when running this script: -
Make sure you run the libraries. Some functions will not give an error
but do not work properly. - We switch between using R and python. When
loading something specific from the model is not working, it probably
has not been run on python yet.

# Setup R

```{r setup-chunk, setup, include=FALSE, cache=TRUE}
knitr::opts_chunk$set(
  dev = "png",
  dpi = 300,
  cache = TRUE,
  fig.height = 15,
  fig.width = 30
)
```

## Install packages

Uncomment if need to install again

```{r install packages}
# install.packages("dplyr")
# install.packages("ggplot2")
# install.packages("car")
# install.packages("rgl")
# install.packages("plotly")
# install.packages("janitor")
# install.packages("data.table")
# install.packages("GGally")
# install.packages("mclust")
# install.packages("fpc")
# install.packages("igraph")
# install.packages("Hmisc")
# install.packages("knitr)
# install.packages("devtools")
# install.packages("styler")
# install.packages("ggsignif")
# install.packages("crayon")
# install.packages("caret")
# install.packages("fpc")

library(ggplot2)
library(stats)
library(car)
library(rgl)
library(plotly)
library(janitor)
library(data.table)
library(GGally)
library(fpc)
library(igraph)
library(Hmisc)
library(stats)
library(knitr)
library(devtools)
library(styler)
library(ggsignif)
library(crayon)
library(readr)
library(clusterpval)
library(tidyverse)
library(extRemes)
library(mclust)
library(caret)
library(dplyr)
library(fpc)

```

# Phenotypic data

In this part of the script, the dataframes are prepared and the
clustering is performed.

## Prepare data

### Load phenotypic data and prepare data

First, load phenotypic data for ABIDE 1 and ABIDE 2.

```{r loading phenotypic data, cache=TRUE}
ABIDE1_pheno <- read.csv("/Volumes/methlab/Students/Jente/Data/Phenotypic/Phenotypic_V1_0b.csv")
ABIDE2_pheno <- read.csv("/Volumes/methlab/Students/Jente/Data/Phenotypic/ABIDEII_Composite_Phenotypic.csv", header = TRUE)
```

First select the variables we will need and build a dataframe with only
these variables

```{r select variables, cache=TRUE}
variables1 <- c("SITE_ID", "SUB_ID", "DX_GROUP", "DSM_IV_TR", "AGE_AT_SCAN", "SEX", "FIQ", "FIQ_TEST_TYPE", "ADI_R_RSRCH_RELIABLE", "ADOS_MODULE", "ADOS_RSRCH_RELIABLE", "ADOS_TOTAL", "ADOS_COMM", "ADOS_SOCIAL", "ADOS_STEREO_BEHAV")

variables2 <- c("SITE_ID", "SUB_ID", "DX_GROUP", "PDD_DSM_IV_TR", "AGE_AT_SCAN", "SEX", "FIQ", "FIQ_TEST_TYPE","ADI_R_RSRCH_RELIABLE", "ADOS_MODULE", "ADOS_RSRCH_RELIABLE", "ADOS_G_TOTAL", "ADOS_G_COMM", "ADOS_G_SOCIAL", "ADOS_G_STEREO_BEHAV")

ABIDE1_pheno_clean <- ABIDE1_pheno[, (names(ABIDE1_pheno) %in% variables1)]
ABIDE2_pheno_clean <- ABIDE2_pheno[, (names(ABIDE2_pheno) %in% variables2)]

# Reorder columns so they are similar for both dataframes.
col_order1 <- variables1
col_order2 <- variables2

ABIDE1_pheno_clean <- ABIDE1_pheno_clean[, col_order1]
ABIDE2_pheno_clean <- ABIDE2_pheno_clean[, col_order2]

```

In the data there are some extreme negative values (-9999). Change these
numbers to NAs.

```{r minus to NAs, cache=TRUE}
ABIDE1_pheno_clean[ABIDE1_pheno_clean < 0] <- NA
ABIDE2_pheno_clean[ABIDE2_pheno_clean < 0] <- NA
```

In the data set, there is a column that note if the data is acquired
reliably. There are a few that are not and therefore we will remove
these subjects. Done by filtering on data where the column is either
reliable (1) or not defined (NA).

```{r remove unreliable, cache=TRUE}
ABIDE1_pheno_clean <- filter(ABIDE1_pheno_clean, ABIDE1_pheno_clean$ADOS_RSRCH_RELIABLE == 1 | is.na(ABIDE1_pheno_clean$ADOS_RSRCH_RELIABLE))
ABIDE1_pheno_clean <- filter(ABIDE1_pheno_clean, ABIDE1_pheno_clean$ADI_R_RSRCH_RELIABLE == 1 | is.na(ABIDE1_pheno_clean$ADI_R_RSRCH_RELIABLE))
ABIDE2_pheno_clean <- filter(ABIDE2_pheno_clean, ABIDE2_pheno_clean$ADOS_RSRCH_RELIABLE == 1 | is.na(ABIDE2_pheno_clean$ADOS_RSRCH_RELIABLE))
ABIDE2_pheno_clean <- filter(ABIDE2_pheno_clean, ABIDE2_pheno_clean$ADI_R_RSRCH_RELIABLE == 1 | is.na(ABIDE2_pheno_clean$ADI_R_RSRCH_RELIABLE))
```

Combine ABIDE 1 and 2 into 1 data set

```{r combine ABIDE 1 and 2}
# Change names dataframes so we can change the column names without changing the original dataframes
forcom1 <- ABIDE1_pheno_clean
forcom2 <- ABIDE2_pheno_clean

# change column names
colnames(forcom2) <- colnames(forcom1)

# combine the datasets
ABIDE_pheno_clean <- rbind(forcom1, forcom2)
```

### Exclusion

We will remove all women due to uneven distribution of women across
sites.

```{r remove women, cache=TRUE}
# Filters out data where sex=1 which is male according to the legend.
ABIDE_pheno_clean <- filter(ABIDE_pheno_clean, ABIDE_pheno_clean$SEX == 1)
```

We can't subgroup TC since they do not have any scores for the clinical
tests. So here we select only participants with autism.

```{r select autism, cache=TRUE}
ABIDE_pheno_autism <- subset(ABIDE_pheno_clean, DX_GROUP == 1)
```

### Normalize clinical scores

Since the scores of the clinical outcomes are all on different scales,
we will normalize them so that one score does not weight heavier than
another score during clustering.

```{r Normalization, cache=TRUE}
dataforclust <- ABIDE_pheno_autism

for (i in 12:(ncol(dataforclust))) { # Loop through the columns that we want to normalize
  
  name <- paste(colnames(dataforclust)[i], "_zscore", sep = "") # Make new name for the new column where the z-scores are stored
  
  dataforclust[, name] <- (dataforclust[, i] - mean(as.numeric(dataforclust[, i], na.rm = TRUE), na.rm = TRUE)) / sd(dataforclust[, i], na.rm = TRUE) #Calculate and store z-scores
}
```

## Cluster

### Use GLM to account for confounding effects

First remove all rows with NA's for any of the needed variables.

```{r create dataframe clustering, cache=TRUE}
dataforclust <- na.omit(dataforclust[, c("SITE_ID", "SUB_ID", "AGE_AT_SCAN", "SEX", "FIQ", "ADOS_MODULE", "ADOS_COMM_zscore", "ADOS_SOCIAL_zscore", "ADOS_STEREO_BEHAV_zscore", "ADOS_TOTAL")])
```

Show the correlation between subscores and confounding effects

```{r, fig.height = 8, figure.width = 10}
# Age

cor.test(dataforclust$AGE_AT_SCAN, dataforclust$ADOS_COMM_zscore)
cor.test(dataforclust$AGE_AT_SCAN, dataforclust$ADOS_SOCIAL_zscore)
cor.test(dataforclust$AGE_AT_SCAN, dataforclust$ADOS_STEREO_BEHAV_zscore)

#IQ 
cor.test(dataforclust$FIQ, dataforclust$ADOS_COMM_zscore)
cor.test(dataforclust$FIQ, dataforclust$ADOS_SOCIAL_zscore)
cor.test(dataforclust$FIQ, dataforclust$ADOS_STEREO_BEHAV_zscore)

#ADOS module
cor.test(dataforclust$ADOS_MODULE, dataforclust$ADOS_COMM_zscore)
cor.test(dataforclust$ADOS_MODULE, dataforclust$ADOS_SOCIAL_zscore)
cor.test(dataforclust$ADOS_MODULE, dataforclust$ADOS_STEREO_BEHAV_zscore)


```

perform the GLM and store residuals.

```{r GLM, cache=TRUE}
glm_test <- glm(dataforclust$ADOS_COMM_zscore ~ dataforclust$AGE_AT_SCAN + dataforclust$SITE_ID + dataforclust$FIQ + dataforclust$ADOS_MODULE + dataforclust$ADOS_SOCIAL_zscore + dataforclust$ADOS_STEREO_BEHAV_zscore)
dataforclust$ADOS_COMM_zscore_res <- glm_test$residuals

glm_test <- glm(dataforclust$ADOS_SOCIAL_zscore ~ dataforclust$AGE_AT_SCAN + dataforclust$SITE_ID + dataforclust$FIQ + dataforclust$ADOS_MODULE + dataforclust$ADOS_COMM_zscore + dataforclust$ADOS_STEREO_BEHAV_zscore)
dataforclust$ADOS_SOCIAL_zscore_res <- glm_test$residuals

glm_test <- glm(dataforclust$ADOS_STEREO_BEHAV_zscore ~ dataforclust$AGE_AT_SCAN + dataforclust$SITE_ID + dataforclust$FIQ + dataforclust$ADOS_MODULE + dataforclust$ADOS_COMM_zscore + dataforclust$ADOS_SOCIAL_zscore)
dataforclust$ADOS_STEREO_BEHAV_zscore_res <- glm_test$residuals
```

### Perform model-based clustering

Here we perform the model-based clustering based on the clinical
subscores.

```{r model cluster, fig.height=10, fig.width=10, cache=TRUE}
# use cluster algorithm
clust_test <- Mclust(dataforclust[, c("ADOS_COMM_zscore_res", "ADOS_SOCIAL_zscore_res", "ADOS_STEREO_BEHAV_zscore_res")], verbose = FALSE)

# Save clustering result 
dataforclust$classification_model <- as.character(clust_test$classification)

# Change classification to character
dataforclust$classification_model <- as.character(dataforclust$classification_model)
```

#### Visualize the clusters

```{r compare model clusters, cache=TRUE, fig.height=7, fig.width=10}
# First we have to make a new dataframe in a long format instead of wide
newdata1 <- data.frame(dataforclust$SUB_ID, dataforclust$classification_model, dataforclust$ADOS_COMM_zscore_res)
colnames(newdata1) <- c("SUB_ID", "Group", "Score")
newdata1$scoretype <- "AODS_COMM_zscore_res"

newdata2 <- data.frame(dataforclust$SUB_ID, dataforclust$classification_model, dataforclust$ADOS_SOCIAL_zscore_res)
colnames(newdata2) <- c("SUB_ID", "Group", "Score")
newdata2$scoretype <- "AODS_SOCIAL_zscore_res"

newdata3 <- data.frame(dataforclust$SUB_ID, dataforclust$classification_model, dataforclust$ADOS_STEREO_BEHAV_zscore_res)
colnames(newdata3) <- c("SUB_ID", "Group", "Score")
newdata3$scoretype <- "AODS_STEREO_BEHAV_zscore_res"

dataforplot <- rbind(newdata1, newdata2, newdata3)

# Define the plot
ggplot(dataforplot, aes(x = scoretype, y = Score, fill = Group)) +
  geom_boxplot(position = position_dodge(width = 0.8), width = 0.6) +
  theme_classic() +
  labs(x = "Subscores", y = "Residuals z-score", title = "Residuals of z-score for each subscore") +
  scale_x_discrete(labels = c("Communication", "Social", "RRBs")) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Subgroup",
                    labels = c("Subgroup 1", "Subgroup 2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12), text = element_text(size=18)) 

# Save the combined plot
ggsave("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Cluster plots/Combined_Boxplot_Subscores.png")
```

Cluster plot

```{r model cluster plot, fig.height=8, fig.width=8, cache=TRUE}

# Get the BIC

BIC = mclustBIC(dataforclust[, c("ADOS_COMM_zscore_res", "ADOS_SOCIAL_zscore_res", "ADOS_STEREO_BEHAV_zscore_res")])

plot(BIC)

png(file="/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Cluster plots/Clusterplot.png", width=8, height = 8, units = "in", res = 1000)
plot(BIC)
dev.off()

```

#### Test the clusters for significance

We test significance by using the clusterpval packages.

```{r significance model clusters, cache=TRUE}
set.seed(1)

# Make function for clustering, needed for the significance function
model_cluster <- function(X) {
  mc <- Mclust(X, verbose = FALSE)
  return(mc$classification)
}

X <- as.matrix(dataforclust[, c("ADOS_COMM_zscore_res", "ADOS_SOCIAL_zscore_res", "ADOS_STEREO_BEHAV_zscore_res")])
rownames(X) <- NULL
cl <- model_cluster(X)

#Test significance
Sig_model <- test_clusters_approx(X, k1 = 1, k2 = 2, cl_fun = model_cluster, cl = cl, ndraws = 10000)

#Show significance
Sig_model
```


#### Test significance sub-scores
```{r}
p_comm = wilcox.test(dataforclust$ADOS_COMM_zscore_res[dataforclust$classification_model==1], dataforclust$ADOS_COMM_zscore_res[dataforclust$classification_model==2])
p_soc = wilcox.test(dataforclust$ADOS_SOCIAL_zscore_res[dataforclust$classification_model==1], dataforclust$ADOS_SOCIAL_zscore_res[dataforclust$classification_model==2])
p_RRB = wilcox.test(dataforclust$ADOS_STEREO_BEHAV_zscore_res[dataforclust$classification_model==1], dataforclust$ADOS_STEREO_BEHAV_zscore_res[dataforclust$classification_model==2])

p_comm
median(dataforclust$ADOS_COMM_zscore_res[dataforclust$classification_model==1])
IQR(dataforclust$ADOS_COMM_zscore_res[dataforclust$classification_model==1])

p_soc
median(dataforclust$ADOS_SOCIAL_zscore_res[dataforclust$classification_model==1])
IQR(dataforclust$ADOS_SOCIAL_zscore_res[dataforclust$classification_model==1])

p_RRB
median(dataforclust$ADOS_STEREO_BEHAV_zscore_res[dataforclust$classification_model==1])
IQR(dataforclust$ADOS_STEREO_BEHAV_zscore_res[dataforclust$classification_model==1])

p.adjust(c(p_comm$p.value, p_soc$p.value, p_RRB$p.value), method="fdr")

wilcox.test(dataforclust$ADOS_TOTAL[dataforclust$classification_model==1], dataforclust$ADOS_TOTAL[dataforclust$classification_model==2])

```


#### Stability analysis

To see if the clusters are stable, use a bootstrap analysis with 1000
repetitions. If the clusters change a lot, this could indicate instable
clusters. A cluster is defined as stable when the same number of
clusters are found.

```{r stability analysis cluster, cache=TRUE}
set.seed(1)

model_cluster_boot <- function(X) {
  mc <- Mclust(X, verbose = FALSE)
  
  clustering_result <- list(mc)  # Adjust this line based on the actual output of Mclust()
  
  nc <- mc$G  # Number of clusters, including noise (if present)
  nccl <- nc  # Number of clusters excluding noise
  
  cluster_list <- list()
  for (i in 1:nccl) {
    cluster_list[[i]] <- mc$classification == i
  }
  
  partition <- mc$classification
  if (nc > nccl) {
    # If noise cluster is present
    cluster_list[[nc]] <- mc$classification == 0  # Assume noise cluster is labeled as 0
    partition <- ifelse(partition == 0, nc, partition)
  }
  
  clustermethod <- "Mclust"  # Adjust the clustering method name
  
  result <- list(
    clustering_result = clustering_result,
    nc = nc,
    nccl = nccl,
    clusterlist = cluster_list,
    partition = partition,
    clustermethod = clustermethod
  )
  
  return(result)
}

b = clusterboot(data = X, B = 1000, clustermethod = model_cluster_boot)

b

```

## Compare clusters on demographics

```{r Demographic differences clusters}
# Difference in age
## assumptions:
qqnorm(dataforclust$AGE_AT_SCAN)
qqline(dataforclust$AGE_AT_SCAN, col = "red")

# not normally distributed so use non parametric test: Man Whitney wilcox test
wilcox.test(dataforclust$AGE_AT_SCAN[dataforclust$classification_model == 1], dataforclust$AGE_AT_SCAN[dataforclust$classification_model == 2])

#Plot age for each subtype
ggplot(dataforclust, aes(x = classification_model, y = AGE_AT_SCAN)) +
  geom_boxplot(aes(fill = classification_model)) +
  theme_classic() +
  labs(x = "Subscores", y = "Age", title = "Age in both subgroups") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), text = element_text(size = 20)) +
  geom_jitter(size = 0.2) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Subgroups", labels = c("Subgroup 1", "Subgroup 2"))

ggsave("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Cluster plots/Demo_age_subtypes.png")



# Differene in IQ
## assumptions:
qqnorm(dataforclust$FIQ)
qqline(dataforclust$FIQ, col = "red")

wilcox.test(dataforclust$FIQ[dataforclust$classification_model == 1], dataforclust$FIQ[dataforclust$classification_model == 2])

#Plot the IQ for each subtype
ggplot(dataforclust, aes(x = classification_model, y = FIQ)) +
  geom_boxplot(aes(fill = classification_model)) +
  theme_classic() +
  labs(x = "Subscores", y = "FIQ", title = "FIQ in both subgroups") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), text = element_text(size = 20)) +
  geom_jitter(size = 0.2) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Subgroups", labels = c("Subgroup 1", "Subgroup 2"))

ggsave("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Cluster plots/Demo_IQ_subtypes.png")


# Difference in module
test_demo <- merge(dataforclust, ABIDE_pheno_clean, by = "SUB_ID") # Merge back with full dataframe to get info about modules.

# Change module to character
test_demo$ADOS_MODULE.x <- as.character(test_demo$ADOS_MODULE.x)

# Test significance
chisq.test(table(test_demo$classification_model, test_demo$ADOS_MODULE.x))

# Count how often each count happens in each cluster
data_modules <- test_demo %>%
  group_by(classification_model, ADOS_MODULE.x) %>%
  summarise(Freq = n())

# Change to percentage for easier visualisation
data_modules$perc <- 0
data_modules$perc[data_modules$classification_model == 1] <- data_modules$Freq[data_modules$classification_model == 1] / length(test_demo$SUB_ID[test_demo$classification_model == 1]) * 100
data_modules$perc[data_modules$classification_model == 2] <- data_modules$Freq[data_modules$classification_model == 2] / length(test_demo$SUB_ID[test_demo$classification_model == 2]) * 100

#Plot the modules for each subtype
ggplot(data_modules, # Grouped barplot using ggplot2
  aes(x = classification_model, y = perc,fill = ADOS_MODULE.x)) +
  geom_bar(stat = "identity",position = "dodge") + 
  theme_classic() +
  labs(x = "Subgroup", y ="Percentage", title = "Percentage of modules in each subgroup") +
  scale_fill_manual(values = c("#a82393","#5b78e2", "#b30d2e"), name = "Module")

ggsave("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Cluster plots/Demo_modules_subtypes.png")

```

# Brain data

Now that we finished our clustering, we can use brain data for the
normative model. The normative model will be done in python. However, we
will here start preparing the data. Then we load the results from the
normative model and perform analysis in following sections.

## Load and prepare dataframes

Lets load all data

```{r load brain data, cache=TRUE}
# First the EULER number
## ABIDE 1
EULER_lh_ABIDE1 <- read.csv("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE1_new/EULER_lh_ABIDE1.csv")
EULER_rh_ABIDE1 <- read.csv("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE1_new/EULER_rh_ABIDE1.csv")

#Change column names
colnames(EULER_lh_ABIDE1) <- c("SUB_ID", "EULER_lh")
colnames(EULER_rh_ABIDE1) <- c("SUB_ID", "EULER_rh")

#Merge left and right and remove NAs
EULER_ABIDE1 <- merge(EULER_lh_ABIDE1, EULER_rh_ABIDE1, by = "SUB_ID") # Merge left and right hemisphere to one dataset
EULER_ABIDE1 <- na.omit(EULER_ABIDE1)

EULER_ABIDE1 <- unique(EULER_ABIDE1) # Remove duplicate rows

# Compute mean EULER
EULER_ABIDE1$meanEULER <- rowMeans(EULER_ABIDE1[, c("EULER_lh", "EULER_rh")])


# ABIDE 2
EULER_lh_ABIDE2 <- read.csv("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE2/EULER_lh_ABIDE2.csv")
EULER_rh_ABIDE2 <- read.csv("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE2/EULER_rh_ABIDE2.csv")

#Change column names
colnames(EULER_lh_ABIDE2) <- c("SUB_ID", "EULER_lh")
colnames(EULER_rh_ABIDE2) <- c("SUB_ID", "EULER_rh")

#Merge left and right and remove NAs
EULER_ABIDE2 <- merge(EULER_lh_ABIDE2, EULER_rh_ABIDE2, by = "SUB_ID") # Merge left and right hemisphere to one dataset
EULER_ABIDE2 <- na.omit(EULER_ABIDE2)

EULER_ABIDE2 <- unique(EULER_ABIDE2) # Remove duplicate rows

#Exclude longitudinal data
exclude_ID_long <- c(50002,50005,50006,50007,50013,50026,50027,50028,50029,50031,50035,50038,50047,50048,50049,50050,50051) #Vector with SUB_ID that need to be excluded
EULER_ABIDE2 <- filter(EULER_ABIDE2, !(EULER_ABIDE2$SUB_ID %in% exclude_ID_long)) #Filter these subjects out

# Compute mean EULER
EULER_ABIDE2$meanEULER <- rowMeans(EULER_ABIDE2[, c("EULER_lh", "EULER_rh")])


# Load cortical thickness
# ABIDE1
CT_lh_Destrieux_ABIDE1 <- read.delim("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE1_new/CT_lh_Destrieux_ABIDE1.txt")
CT_rh_Destrieux_ABIDE1 <- read.delim("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE1_new/CT_rh_Destrieux_ABIDE1.txt")

#Change column names
colnames(CT_lh_Destrieux_ABIDE1)[1] <- c("SUB_ID")
colnames(CT_rh_Destrieux_ABIDE1)[1] <- c("SUB_ID")

#Merge left and right
CT_Destrieux_ABIDE1 <- merge(CT_lh_Destrieux_ABIDE1, CT_rh_Destrieux_ABIDE1, by = "SUB_ID")


# ABIDE 2
CT_lh_Destrieux_ABIDE2 <- read.delim("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE2/CT_lh_Destrieux_ABIDE2.txt")
CT_rh_Destrieux_ABIDE2 <- read.delim("/Volumes/methlab/Students/Jente/Data/OutputFreeSurfer/ABIDE2/CT_rh_Destrieux_ABIDE2.txt")

#Change column names
colnames(CT_lh_Destrieux_ABIDE2)[1] <- c("SUB_ID")
colnames(CT_rh_Destrieux_ABIDE2)[1] <- c("SUB_ID")

#Merge left and right
CT_Destrieux_ABIDE2 <- merge(CT_lh_Destrieux_ABIDE2, CT_rh_Destrieux_ABIDE2, by = "SUB_ID")

#Exclude longitudinal data
CT_Destrieux_ABIDE2 <- filter(CT_Destrieux_ABIDE2, !(CT_Destrieux_ABIDE2$SUB_ID %in% exclude_ID_long)) #Filter these subjects out
```

We will exclude all participants with an Euler number larger than 300.

```{r remove participants with bad quality, cache=TRUE}
# ABIDE1
sub_keep <- EULER_ABIDE1$SUB_ID[EULER_ABIDE1$meanEULER > -300] # Create vector of subject numbers that are included
CT_Destrieux_ABIDE1 <- filter(CT_Destrieux_ABIDE1, CT_Destrieux_ABIDE1$SUB_ID %in% sub_keep) #Filter on subjects that are included

# ABIDE 2
sub_keep <- EULER_ABIDE2$SUB_ID[EULER_ABIDE2$meanEULER > -300] # Create vector of subject numbers that are included
CT_Destrieux_ABIDE2 <- filter(CT_Destrieux_ABIDE2, CT_Destrieux_ABIDE2$SUB_ID %in% sub_keep) #Filter on subjects that are included

## Merge dataframes with Euler number
CT_Destrieux_ABIDE1 <- merge(CT_Destrieux_ABIDE1, EULER_ABIDE1, by = "SUB_ID")
CT_Destrieux_ABIDE2 <- merge(CT_Destrieux_ABIDE2, EULER_ABIDE2, by = "SUB_ID")
```

Merge dataframes

```{r combine ABIDE 1 and 2 brain data, cache=TRUE}
# Merge datasets
CT_Destrieux <- rbind(CT_Destrieux_ABIDE1, CT_Destrieux_ABIDE2)
# Delete unneeded columns
CT_Destrieux <- subset(CT_Destrieux, select = -c(BrainSegVolNotVent.x, eTIV.x, BrainSegVolNotVent.y, eTIV.y))
```

Data preparation for normative model:

```{r merge brain and phenotype, cache=TRUE}
#Name which columns you want to use for the normative model
cov_normative <- ABIDE_pheno_clean[, c("SUB_ID", "SITE_ID", "DX_GROUP", "AGE_AT_SCAN", "SEX", "FIQ")]

#Merge covariates with brain data
data_normative_Destrieux <- merge(cov_normative, CT_Destrieux, by = "SUB_ID")

# Exclude women
data_normative_Destrieux <- filter(data_normative_Destrieux, data_normative_Destrieux$SEX == 1)

#Get dataframe of participants which have a cortical thickness of 0. We will exclude these. 
Data_zeros = data_normative_Destrieux[rowSums(data_normative_Destrieux[, 7:156] == 0, na.rm = TRUE) > 0, ] 
data_normative_Destrieux <- filter(data_normative_Destrieux, !(data_normative_Destrieux$SUB_ID %in% Data_zeros$SUB_ID)) # Remove participants with CT of 0.
```

Export dataset for normative model

```{r export data NM}
write.table(data_normative_Destrieux, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/Data/Data_normative_Destrieux.txt", append = FALSE, sep = ",", dec = ".", col.names = TRUE)
```

# Normative modelling

From this part on we use the data from the normative model. This model
is run in Python. So make sure you run the model before you start this
part of the code.

## Load deviation scores from the normative model

```{r Load results normative model}
Deviation_scores <- read_csv("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/blr/powell/outputs/Deviation_scores.csv", col_types = cols(...1 = col_skip()))
```

Merge with clustering results so we can compare between groups.

```{r merge dev scores with pheno data}
Brain_data_results <- merge(dataforclust, Deviation_scores, by = "SUB_ID") # Data subgroups

#Also merge with complete dataset so we can compare diagnosis
Brain_data_results_all = merge(ABIDE_pheno_clean, Deviation_scores, by="SUB_ID") # Data all

```

## SVM
We will make a dataframe that we will use in the classification in
python.

```{r dataframe SVM}
# Make dataframe for SVM
Data_SVM_TC = filter(Brain_data_results_all, Brain_data_results_all$DX_GROUP==2)
common_cols <- intersect(colnames(Data_SVM_TC), colnames(Brain_data_results))
Data_SVM_TC <- Data_SVM_TC[, common_cols]
Data_SVM_TC$classification_model = "0"

Data_SVM_ASD = Brain_data_results
common_cols <- intersect(colnames(Data_SVM_TC), colnames(Brain_data_results))
Data_SVM_ASD <- Data_SVM_ASD[, common_cols]

Data_SVM = rbind(Data_SVM_ASD, Data_SVM_TC)


#Save this dataframe for SVM
write.table(Data_SVM, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/SVM/Data.csv", append = FALSE, sep=",", dec=".", col.names = TRUE)
```

## Compare deviation scores

We compare the deviation scores from the normative model between the
subgroups. We will only show and save the plot if the area is
signficiant after FDR correction.

```{r compare deviation score subtypes, cache=TRUE}
# make empty dataframe to store results
p_values <- data.frame(matrix(ncol = 7, nrow = 0))
#Change colnames
colnames(p_values) <- c("ROI", "p_value_abs", "p_value_adjusted_abs", "p_value_pos", "p_value_adjusted_pos", "p_value_neg", "p_value_adjusted_neg")
  
i <- 0
#Loop through each ROI
for (ROI in colnames(Brain_data_results)[14:163]) {
  
  i <- i + 1
  p_values[i,1] = ROI
  
  #Save data for each ROI for each cluster
  data_roi <- Brain_data_results[c(ROI, "classification_model")]
  data_roi_abs <- Brain_data_results[c(ROI, "classification_model")]

  # Absolute
  data_roi_abs[, ROI] <- abs(data_roi[, ROI])
  
  data_roi_abs_1 <- filter(data_roi_abs, data_roi_abs$classification_model == 1)
  data_roi_abs_2 <- filter(data_roi_abs, data_roi_abs$classification_model == 2)
  
  #Calculate p-values and save
  p_values[i, 2] <- wilcox.test(as.numeric(data_roi_abs_1[, c(ROI)]), as.numeric(data_roi_abs_2[, c(ROI)]))$p.value
  
  # Prepare for positive and negative
  data_roi1 <- filter(data_roi, data_roi$classification_model == 1)
  data_roi2 <- filter(data_roi, data_roi$classification_model == 2)
  
  # positive
  #Calculate p-values and save
  p_values[i, 4] <- wilcox.test(as.numeric(data_roi1[, c(ROI)][data_roi1[,c(ROI)]>0]), as.numeric(data_roi2[, c(ROI)][data_roi2[,c(ROI)]>0]))$p.value

  # negative
  
  #Calculate p-values and save
  p_values[i, 6] <- wilcox.test(as.numeric(data_roi1[, c(ROI)][data_roi1[,c(ROI)]<0]), as.numeric(data_roi2[, c(ROI)][data_roi2[,c(ROI)]<0]))$p.value
 }

#Adjust p values for multiple comparison
p_values$p_value_adjusted_abs <- p.adjust(p_values$p_value_abs, method = "fdr")
p_values$p_value_adjusted_pos <- p.adjust(p_values$p_value_pos, method = "fdr")
p_values$p_value_adjusted_neg <- p.adjust(p_values$p_value_neg, method = "fdr")

  

for (i in 1:150){
#Plot if ROI is significant, otherwise not and show message about significance.
  if (p_values[i, 3] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))

    print(
      ggplot(data_roi, aes(x = "classification_model", y = Brain_data_results[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup absolute")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")

        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values$ROI[i],"Sig_devscores_subtypes.png"))
  }
  
  if (p_values[i, 5] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))

    print(
      ggplot(data_roi, aes(x = "classification_model", y = Brain_data_results[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup positive")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")

        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values$ROI[i],"Sig_devscores_subtypes.png"))
  }
  
  if (p_values[i, 7] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))

    print(
      ggplot(data_roi, aes(x = "classification_model", y = Brain_data_results[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup negative")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")

        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values$ROI[i],"Sig_devscores_subtypes.png"))
  }
}

```

We compare the deviation scores from the normative model between autism
and TC. We will only show and save the plot if the area is signficiant
after FDR correction.

```{r compare deviation score diagnosis, cache=TRUE}
# make empty dataframe to store results
p_values_diag <- data.frame(matrix(ncol = 7, nrow = 0))
#Change colnames
colnames(p_values_diag) <-  c("ROI", "p_value_abs", "p_value_adjusted_abs", "p_value_pos", "p_value_adjusted_pos", "p_value_neg", "p_value_adjusted_neg")

i <- 0
#Loop through each ROI
for (ROI in colnames(Brain_data_results_all)[16:165]) {
  
  i <- i + 1
  p_values_diag[i,1] = ROI
  
  #Save data for each ROI for each cluster
  data_roi <- Brain_data_results_all[c(ROI, "DX_GROUP")]
  data_roi_abs <- Brain_data_results_all[c(ROI, "DX_GROUP")]


  # Absolute
  data_roi_abs[, ROI] <- abs(data_roi[, ROI])
  
  data_roi_abs_ASD <- filter(data_roi_abs, data_roi_abs$DX_GROUP == 1)
  data_roi_abs_TC <- filter(data_roi_abs, data_roi_abs$DX_GROUP == 2)
  
  #Calculate p-values and save
  p_values_diag[i, 2] <- wilcox.test(as.numeric(data_roi_abs_ASD[, c(ROI)]), as.numeric(data_roi_abs_TC[, c(ROI)]))$p.value
  
  # Prepare for positive and negative
  data_roiASD <- filter(data_roi, data_roi$DX_GROUP == 1)
  data_roiTC <- filter(data_roi, data_roi$DX_GROUP == 2)
  
  # positive
  #Calculate p-values and save
  p_values_diag[i, 4] <- wilcox.test(as.numeric(data_roiASD[, c(ROI)][data_roiASD[,c(ROI)]>0]), as.numeric(data_roiTC[, c(ROI)][data_roiTC[,c(ROI)]>0]))$p.value

  # negative
  
  #Calculate p-values and save
  p_values_diag[i, 6] <- wilcox.test(as.numeric(data_roiASD[, c(ROI)][data_roiASD[,c(ROI)]<0]), as.numeric(data_roiTC[, c(ROI)][data_roiTC[,c(ROI)]<0]))$p.value
}

#Adjust p values for multiple comparison
p_values_diag$p_value_adjusted_abs <- p.adjust(p_values_diag$p_value_abs, method = "fdr")
p_values_diag$p_value_adjusted_pos <- p.adjust(p_values_diag$p_value_pos, method = "fdr")
p_values_diag$p_value_adjusted_neg <- p.adjust(p_values_diag$p_value_neg, method = "fdr")
 

Brain_data_results_all$DX_GROUP = as.character(Brain_data_results_all$DX_GROUP)

i <- 0
for (ROI in colnames(Brain_data_results_all)[16:165]){
  
  i <- i + 1
  
  #Plot if ROI is significant, otherwise not and show message about significance.
  if (p_values_diag[i, 3] < 0.05) {
    
    
    plotdata = Brain_data_results_all
    plotdata[ROI] = abs(plotdata[ROI])

    print("absolute")
    print(p_values_diag[i, 1])
    print(wilcox.test(plotdata[plotdata$DX_GROUP == 1, ROI], plotdata[plotdata$DX_GROUP == 2, ROI]))
    print(p_values_diag[i,3])
    print(median(plotdata[plotdata$DX_GROUP == 1, ROI]))
    print(IQR(plotdata[plotdata$DX_GROUP == 1, ROI]))
    print(median(plotdata[plotdata$DX_GROUP == 2, ROI]))
    print(IQR(plotdata[plotdata$DX_GROUP == 2, ROI]))

    print(
      ggplot(plotdata, aes(x = DX_GROUP, y = .data[[ROI]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(ROI, "for TC and Autism Absolute deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values_diag$ROI[i],"Sig_devscores_diagnosis_abs.png"))
  }
  
  if (p_values_diag[i,5]<0.05){
    plotdata_pos = filter(Brain_data_results_all, Brain_data_results_all[ROI] > 0)
    
    print("positive")
    print(p_values_diag[i, 1])
    print(wilcox.test(plotdata_pos[plotdata_pos$DX_GROUP == 1, ROI], plotdata_pos[plotdata_pos$DX_GROUP == 2, ROI]))
    print(p_values_diag[i,5])
    print(median(plotdata_pos[plotdata_pos$DX_GROUP == 1, ROI]))
    print(IQR(plotdata_pos[plotdata_pos$DX_GROUP == 1, ROI]))
    print(median(plotdata_pos[plotdata_pos$DX_GROUP == 2, ROI]))
    print(IQR(plotdata_pos[plotdata_pos$DX_GROUP == 2, ROI]))
    
    print(
      ggplot(plotdata_pos, aes(x = DX_GROUP, y = .data[[ROI]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(ROI, "for TC and Autism Positive deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values_diag$ROI[i],"Sig_devscores_diagnosis_pos.png"))
  }
  
  if (p_values_diag[i,7]<0.05){
    plotdata_neg = filter(Brain_data_results_all, Brain_data_results_all[ROI] < 0)
    
    print("negative")
    print(p_values_diag[i, 1])
    print(wilcox.test(plotdata_neg[plotdata_neg$DX_GROUP == 1, ROI], plotdata_neg[plotdata_neg$DX_GROUP == 2, ROI]))
    print(p_values_diag[i,7])
    print(median(plotdata_neg[plotdata_neg$DX_GROUP == 1, ROI]))
    print(IQR(plotdata_neg[plotdata_neg$DX_GROUP == 1, ROI]))
    print(median(plotdata_neg[plotdata_neg$DX_GROUP == 2, ROI]))
    print(IQR(plotdata_neg[plotdata_neg$DX_GROUP == 2, ROI]))
    
    print(
      ggplot(plotdata_neg, aes(x = DX_GROUP, y = .data[[ROI]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(ROI, "for TC and Autism Negative deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values_diag$ROI[i],"Sig_devscores_diagnosis_neg.png"))
  }
}
```

```{r}
if (p_values_diag[i, 5] < 0.05) {
    print(
      ggplot(data_roi, aes(x = DX_GROUP, y = Brain_data_results_all[,p_values_diag$ROI[i]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(p_values_diag$ROI[i], "for TC and Autism Positive deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values_diag$ROI[i],"Sig_devscores_diagnosis_pos.png"))
  }
  
  if (p_values_diag[i, 7] < 0.05) {
    print(
      ggplot(data_roi, aes(x = DX_GROUP, y = Brain_data_results_all[,p_values_diag$ROI[i]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(p_values_diag$ROI[i], "for TC and Autism Negative deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/", p_values_diag$ROI[i],"Sig_devscores_diagnosis_neg.png"))
  }
```

## Atypicality index with extreme value statistics

Load data from normative model in long format

```{r load Z scores long format}
Z_df <- read.csv("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/Z_df.csv")

# Make column with absolute values of CT
Z_df$CTabs <- abs(Z_df$CT)
```

Extreme value statistics

```{r extreme value statistics}
# Find maximum value for the 1% maximum or minimum of each block (i.e., subject)
Z_max <- data.frame(matrix(ncol = 4, nrow = length(unique(Z_df$SUB_ID))))
colnames(Z_max) <- c("SUB_ID", "positive_max", "negative_max", "absolute_max")

i <- 0
for (sub in unique(Z_df$SUB_ID)) { # Loop through each subject
  i <- i + 1

  Z_max[i, 1] <- sub

  positive_1pct_cutoff <- quantile(Z_df$CT[Z_df$SUB_ID == sub], 0.99, na.rm = TRUE)
  negative_1pct_cutoff <- quantile(Z_df$CT[Z_df$SUB_ID == sub], 0.01, na.rm = TRUE)
  absolute_1pct_cutoff <- quantile(Z_df$CTabs[Z_df$SUB_ID == sub], 0.99, na.rm = TRUE)

  Z_sub <- Z_df$CT[Z_df$SUB_ID == sub]
  Z_sub_abs <- Z_df$CTabs[Z_df$SUB_ID == sub]

  Z_max[i, 2] <- mean(Z_sub[Z_sub > positive_1pct_cutoff])
  Z_max[i, 3] <- mean(Z_sub[Z_sub < negative_1pct_cutoff])
  Z_max[i, 4] <- mean(Z_sub_abs[Z_sub_abs > absolute_1pct_cutoff])
}
```

Split into TC and ASD so we can compare the Atypicality index between
these groups.

```{r Prepare dataframes for comparison Atypicality index diagnosis, cache=TRUE}
Z_max_ASD <- filter(Z_max, Z_max$SUB_ID %in% ABIDE_pheno_clean$SUB_ID[ABIDE_pheno_clean$DX_GROUP == 1])
Z_max_TC <- filter(Z_max, Z_max$SUB_ID %in% ABIDE_pheno_clean$SUB_ID[ABIDE_pheno_clean$DX_GROUP == 2])

# also make a column which group for the plots.
Z_max_ASD$group <- "ASD"
Z_max_TC$group <- "TC"

Z_max_diagnosis_plot <- rbind(Z_max_ASD, Z_max_TC)
```

Compare these Atypicality indexes between autism and TC

```{r atypicality index between diagnosis, cache=TRUE}
# Positive
## assumptions normality:
qqnorm(Z_max_ASD$positive_max)
qqline(Z_max_ASD$positive_max, col = "red")

qqnorm(Z_max_TC$positive_max)
qqline(Z_max_TC$positive_max, col = "red")

## assumptions equal variance:
var.test(Z_max_ASD$positive_max, Z_max_TC$positive_max)

t_test_positive <- wilcox.test(Z_max_ASD$positive_max, Z_max_TC$positive_max)

# Negative
## assumptions normality:
qqnorm(Z_max_ASD$negative_max)
qqline(Z_max_ASD$negative_max, col = "red")

qqnorm(Z_max_TC$negative_max)
qqline(Z_max_TC$negative_max, col = "red")

## assumptions equal variance:
var.test(Z_max_ASD$negative_max, Z_max_TC$negative_max)

t_test_negative <- wilcox.test(Z_max_ASD$negative_max, Z_max_TC$negative_max)

# Absolute
## assumptions normality:
qqnorm(Z_max_ASD$absolute_max)
qqline(Z_max_ASD$absolute_max, col = "red")

qqnorm(Z_max_TC$absolute_max)
qqline(Z_max_TC$absolute_max, col = "red")

## assumptions equal variance:
var.test(Z_max_ASD$absolute_max, Z_max_TC$absolute_max)

t_test_absolute <- wilcox.test(Z_max_ASD$absolute_max, Z_max_TC$absolute_max)

# Multiple comparison correction
p_values_tests = c(t_test_positive$p.value, t_test_negative$p.value, t_test_absolute$p.value)
p.adjust(p_values_tests, method="fdr")


# Visualize differences
ggplot(Z_max_diagnosis_plot, aes(group, fill = group)) +
  geom_boxplot(aes(y = positive_max, x = "Positive"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = negative_max, x = "Negative"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = absolute_max, x = "Absolute"), size=0.3, outlier.size=0.3) +
  theme_classic() +
  labs(x = "Atypicality Index", y = "Deviation score", title = "Atypicality Index differences between TC and Autism") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels = c("Autism", "TC")
  )

ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/","dif_abnormalindex_diag.png"))

    
# Descriptives
t_test_positive
median(Z_max_ASD$positive_max)
IQR(Z_max_ASD$positive_max)
median(Z_max_TC$positive_max)
IQR(Z_max_TC$positive_max)

t_test_negative
median(Z_max_ASD$negative_max)
IQR(Z_max_ASD$negative_max)
median(Z_max_TC$negative_max)
IQR(Z_max_TC$negative_max)

t_test_absolute
median(Z_max_ASD$absolute_max)
IQR(Z_max_ASD$absolute_max)
median(Z_max_TC$absolute_max)
IQR(Z_max_TC$absolute_max)
```

Split into ASD subgroups so we can compare the Atypicality index between
these groups.

```{r prepare dataframes for Atypicality index subtypes}
#Split dataframes into subtypes
Z_max_clust1 <- filter(Z_max, Z_max$SUB_ID %in% dataforclust$SUB_ID[dataforclust$classification_model == 1])
Z_max_clust2 <- filter(Z_max, Z_max$SUB_ID %in% dataforclust$SUB_ID[dataforclust$classification_model == 2])

# also make a column which group for the plots.
Z_max_clust1$group <- "clust1"
Z_max_clust2$group <- "clust2"

#Bind the dataframes together
Z_max_plot <- rbind(Z_max_clust1, Z_max_clust2)
```

Compare these Atypicality indexes between subgroups

```{r Atypicality index subtypes}
# Positive
## assumptions normality:
qqnorm(Z_max_clust1$positive_max)
qqline(Z_max_clust1$positive_max, col = "red")

qqnorm(Z_max_clust2$positive_max)
qqline(Z_max_clust2$positive_max, col = "red")

## assumptions equal variance:
var.test(Z_max_clust1$positive_max, Z_max_clust2$positive_max)

t_test_positive <- wilcox.test(Z_max_clust1$positive_max, Z_max_clust2$positive_max)

# Negative
## assumptions normality:
qqnorm(Z_max_clust1$negative_max)
qqline(Z_max_clust1$negative_max, col = "red")

qqnorm(Z_max_clust2$negative_max)
qqline(Z_max_clust2$negative_max, col = "red")

## assumptions equal variance:
var.test(Z_max_clust1$negative_max, Z_max_clust2$negative_max)

t_test_negative <- wilcox.test(Z_max_clust1$negative_max, Z_max_clust2$negative_max)

# Absolute
## assumptions normality:
qqnorm(Z_max_clust1$absolute_max)
qqline(Z_max_clust1$absolute_max, col = "red")

qqnorm(Z_max_clust2$absolute_max)
qqline(Z_max_clust2$absolute_max, col = "red")

## assumptions equal variance:
var.test(Z_max_clust1$absolute_max, Z_max_clust2$absolute_max)

t_test_absolute <- wilcox.test(Z_max_clust1$absolute_max, Z_max_clust2$absolute_max)

# Multiple comparison correction
p_values_testsub = c(t_test_positive$p.value, t_test_negative$p.value, t_test_absolute$p.value)
p.adjust(p_values_testsub, method="fdr")

# Visualize differences
ggplot(Z_max_plot, aes(group, fill = group)) +
  geom_boxplot(aes(y = positive_max, x = "Positive"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = negative_max, x = "Negative"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = absolute_max, x = "Absolute"), size=0.3, outlier.size=0.3) +
  theme_classic() +
  labs(x = "Atypicality Index", y = "Deviation score", title = "Atypicality Index differences between subgroups") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels = c("Autism", "TC")
  )

ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/","dif_abnormalindex_subs.png"))


# Descriptives
t_test_positive
median(Z_max_clust1$positive_max)
IQR(Z_max_clust1$positive_max)
median(Z_max_clust2$positive_max)
IQR(Z_max_clust2$positive_max)

t_test_negative
median(Z_max_clust1$negative_max)
IQR(Z_max_clust1$negative_max)
median(Z_max_clust2$negative_max)
IQR(Z_max_clust2$negative_max)

t_test_absolute
median(Z_max_clust1$absolute_max)
IQR(Z_max_clust1$absolute_max)
median(Z_max_clust2$absolute_max)
IQR(Z_max_clust2$absolute_max)
```

## P-values for thresholding

For the following analyses and visualisation in python we use a fixed
threshold so we need the p_values. Then for the sensitivity analysis we
also use a individual threshold with FDR correction so we also calculate
the FDR corrected p values.

```{r calculate p values Z-scores}
#Calculate p values for each Z-score under a normal distribution
Z_df$pvalue <- pnorm(Z_df$CTabs, lower.tail = FALSE)

#Perform FDR correction for each participant separately
Z_df <- Z_df %>%
  group_by(SUB_ID) %>%
  mutate(pvalue_fdr = p.adjust(pvalue, method = "fdr"))
```

## Test differences in count significant deviations between groups

Count the number of significant deviations for each participant and
compare this between participants.

```{r Differences in counts}
# Count the number of significant areas
counts <- data.frame(matrix(ncol = 0, nrow = length(unique(Z_df$SUB_ID))))
counts$SUB_ID <- unique(Z_df$SUB_ID)

counts <- Z_df %>%
  group_by(SUB_ID) %>%
  summarise(counts = sum(pvalue < 0.005))

# Merge back with dataframe so we have the information about the groups.
## Compare TC with autism

counts_all <- merge(counts, ABIDE_pheno_clean, by = "SUB_ID")

# Change diagnosis to character instead of numeric
counts_all$DX_GROUP <- as.character(counts_all$DX_GROUP)

## Test assumptions
qqnorm(counts_all$counts)
qqline(counts_all$counts, col = "red")

wilcox.test(counts_all$counts[counts_all$DX_GROUP == 1], counts_all$counts[counts_all$DX_GROUP == 2])

## Visualize
ggplot(counts_all, aes_string(x = "DX_GROUP", y = "counts")) +
  geom_boxplot(aes(fill = DX_GROUP)) +
  theme_classic() +
  labs(x = "Group", y = "Count deviations", title = "Count deviations differences between TC and Autism") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Group")

    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/","dif_count_diagnosis.png"))


## Compare between subgroups
counts_ASD <- merge(counts, dataforclust, by = "SUB_ID")

## Test assumptions
qqnorm(counts_ASD$counts)
qqline(counts_ASD$counts, col = "red")

wilcox.test(counts_ASD$counts[counts_ASD$classification_model == 1], counts_ASD$counts[counts_ASD$classification_model == 2])

## Visualize
ggplot(counts_ASD, aes_string(x = "classification_model", y = "counts")) +
  geom_boxplot(aes(fill = classification_model)) +
  theme_classic() +
  labs(x = "Subgroup", y = "Count deviations", title = "Count deviations differences between defined subgroups") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Subgroups")

    ggsave(paste("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/Rstudio scripts/Plots/Statistics NM_new/","dif_count_subtypes.png"))
    
    
  

```

## Save data so we can plot in python

```{r save significance data}
write.table(Z_df, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/P_df.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)

```

We want to get brain maps for the different subgroups seperately. So
save the data for each subgroup seperately so it's easy to handle in
python.

```{r data for statistic brain maps subtypes}
subs_1 <- dataforclust$SUB_ID[dataforclust$classification_model == 1]
subs_2 <- dataforclust$SUB_ID[dataforclust$classification_model == 2]

Z_df_1 <- subset(Z_df, Z_df$SUB_ID %in% subs_1)
Z_df_2 <- subset(Z_df, Z_df$SUB_ID %in% subs_2)

write.table(Z_df_1, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/Z_df_subtype1.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)
write.table(Z_df_2, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/Z_df_subtype2.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)
```

## Statistics overlap maps

Prepare data We need to work with the Z_df file since those contain the
information about significance. However, we need a wide format instead
of a long format so we can loop through the ROIs and count all
parcitipants together. We already did this in python so we'll load the
data and use that.

```{r}
# Create a function to read and process the data
read_data <- function(file_path, hemi, direction) {
  data <- read.csv(file_path)
  data$hemi <- hemi
  data$direction <- direction
  data
}

# Define the file paths and corresponding labels
file_paths <- c(
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_z2_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_z2_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_z2_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_z2_2.csv"
)

labels <- c(
  "ASD_left_positive", "ASD_right_positive", "ASD_left_negative", "ASD_right_negative",
  "TC_left_positive", "TC_right_positive", "TC_left_negative", "TC_right_negative",
  "sub1_left_positive", "sub1_right_positive", "sub1_left_negative", "sub1_right_negative",
  "sub2_left_positive", "sub2_right_positive", "sub2_left_negative", "sub2_right_negative"
)

# Initialize empty lists
count_data <- vector("list", length(file_paths))
all_data <- list()

# Read and process the data
for (i in seq_along(file_paths)) {
  file_path <- file_paths[i]
  label <- labels[i]
  hemi <- ifelse(grepl("left", label), "left", "right")
  direction <- ifelse(grepl("positive", label), "positive", "negative")
  
  count_data[[i]] <- read_data(file_path, hemi, direction)
  
  # Combine datasets into a single list
  all_data[[label]] <- count_data[[i]]
}

# Combine all datasets into one for each group
counts_ASD_all <- do.call(rbind, count_data[1:4])
counts_TC_all <- do.call(rbind, count_data[5:8])
counts_sub1_all <- do.call(rbind, count_data[9:12])
counts_sub2_all <- do.call(rbind, count_data[13:16])

# Create column to loop through
counts_ASD_all$loopname <- paste(counts_ASD_all$ROI, counts_ASD_all$hemi, counts_ASD_all$direction)
counts_TC_all$loopname <- paste(counts_TC_all$ROI, counts_TC_all$hemi, counts_TC_all$direction)
counts_sub1_all$loopname <- paste(counts_sub1_all$ROI, counts_sub1_all$hemi, counts_sub1_all$direction)
counts_sub2_all$loopname <- paste(counts_sub2_all$ROI, counts_sub2_all$hemi, counts_sub2_all$direction)

```

Compare ASD vs TC

```{r}
counts_ASD_all$percentage = as.numeric(counts_ASD_all$percentage)
counts_TC_all$percentage = as.numeric(counts_TC_all$percentage)

# Positive
## assumptions normality:
qqnorm(counts_ASD_all$percentage)
qqline(counts_ASD_all$percentage, col = "red")

qqnorm(counts_TC_all$percentage)
qqline(counts_TC_all$percentage, col = "red")

## assumptions equal variance:
var.test(counts_ASD_all$percentage, counts_TC_all$percentage)

wilcox.test(counts_ASD_all$percentage, counts_TC_all$percentage)

```

Compare Subgroups

```{r}
counts_sub1_all$percentage = as.numeric(counts_sub1_all$percentage)
counts_sub2_all$percentage = as.numeric(counts_sub2_all$percentage)

# Positive
## assumptions normality:
qqnorm(counts_sub1_all$percentage)
qqline(counts_sub1_all$percentage, col = "red")

qqnorm(counts_sub2_all$percentage)
qqline(counts_sub2_all$percentage, col = "red")

## assumptions equal variance:
var.test(counts_sub1_all$percentage, counts_sub2_all$percentage)


wilcox.test(counts_sub1_all$percentage, counts_sub2_all$percentage)

```

# Plots for methods

Here we make a plot for the extreme value statistics. We choose one
randomly that looks nice.

```{r, fig.height=10, fig.width=10}
# Select one row of the columns with brain data
row_data <- abs(unlist(Brain_data_results_all[12, 16:165])) 

# Calculate the threshold values for the top and bottom 0.5% of the data
threshold <- quantile(row_data, 0.99)

# Create a vector of colors for the bars based on their value compared to the threshold values
colors <- ifelse(row_data > threshold, "red", "lightblue")

# Plot the histogram using ggplot2
ggplot(data = data.frame(x = row_data, color = colors), aes(x = x, fill = color)) +
  geom_histogram(binwidth = 0.1, color = "black") +
  xlab("Value") +
  ylab("Count") +
  ggtitle("Histogram of 1 participant for methods") +
  theme_bw() +
  geom_vline(xintercept = threshold, color = "red", linetype = "dashed", size = 1) +
  scale_fill_manual(values = c("white", "red")) +
  theme(legend.position="none")


```

# Sensitivity analysis

## Individual FDR correction

### Count analysis

```{r}
# Count the number of significant areas
counts <- data.frame(matrix(ncol = 0, nrow = length(unique(Z_df$SUB_ID))))
counts$SUB_ID <- unique(Z_df$SUB_ID)

counts <- Z_df %>%
  group_by(SUB_ID) %>%
  summarise(counts = sum(pvalue_fdr < 0.05))

# Merge back with dataframe so we have the information about the groups.
counts_all <- merge(counts, ABIDE_pheno_clean, by = "SUB_ID")

# Change diagnosis to character instead of numeric
counts_all$DX_GROUP <- as.character(counts_all$DX_GROUP)

## Test assumptions
qqnorm(counts_all$counts)
qqline(counts_all$counts, col = "red")

wilcox.test(counts_all$counts[counts_all$DX_GROUP == 1], counts_all$counts[counts_all$DX_GROUP == 2])



## Compare between autism subtypes
counts_ASD <- merge(counts, dataforclust, by = "SUB_ID")

## Test assumptions
qqnorm(counts_ASD$counts)
qqline(counts_ASD$counts, col = "red")

wilcox.test(counts_ASD$counts[counts_ASD$classification_model == 1], counts_ASD$counts[counts_ASD$classification_model == 2])

    
## Compare between subtypes and TC
    
wilcox.test(counts_ASD$counts[counts_ASD$classification_model==1], counts_all$counts[counts_all$DX_GROUP==2])
wilcox.test(counts_ASD$counts[counts_ASD$classification_model==2], counts_all$counts[counts_all$DX_GROUP==2])


```

### Prepare data for plots python

```{r}
ind_FDR = Z_df
ind_FDR$CT[ind_FDR$pvalue_fdr > 0.05] <- 0 # When the individual FDR p-value is higher than 0.05, we set the CT to 0 so we can use a threhold of >0 for the brain maps.

write.table(ind_FDR, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/individual_FDR.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)

```

### Statistics overlap maps

Prepare data We need to work with the Z_df file since those contain the
information about significance. However, we need a wide format instead
of a long format so we can loop through the ROIs and count all
parcitipants together. We already did this in python so we'll load the
data and use that.

```{r}
# Create a function to read and process the data
read_data <- function(file_path, hemi, direction) {
  data <- read.csv(file_path)
  data$hemi <- hemi
  data$direction <- direction
  data
}
# Define the file paths and corresponding labels
file_paths <- c(
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_2_ind_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_2_ind_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_2_ind_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_2_ind_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_2_ind_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_2_ind_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_2_ind_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_2_ind_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_2_ind_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_2_ind_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_2_ind_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_2_ind_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_left_2_ind_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/positive_right_2_ind_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_left_2_ind_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model/results/negative_right_2_ind_2.csv"
)


labels <- c(
  "ASD_left_positive", "ASD_right_positive", "ASD_left_negative", "ASD_right_negative",
  "TC_left_positive", "TC_right_positive", "TC_left_negative", "TC_right_negative",
  "sub1_left_positive", "sub1_right_positive", "sub1_left_negative", "sub1_right_negative",
  "sub2_left_positive", "sub2_right_positive", "sub2_left_negative", "sub2_right_negative"
)

# Initialize empty lists
count_data <- vector("list", length(file_paths))
all_data <- list()

# Read and process the data
for (i in seq_along(file_paths)) {
  file_path <- file_paths[i]
  label <- labels[i]
  hemi <- ifelse(grepl("left", label), "left", "right")
  direction <- ifelse(grepl("positive", label), "positive", "negative")
  
  count_data[[i]] <- read_data(file_path, hemi, direction)
  
  # Combine datasets into a single list
  all_data[[label]] <- count_data[[i]]
}

# Combine all datasets into one for each group
counts_ASD_all <- do.call(rbind, count_data[1:4])
counts_TC_all <- do.call(rbind, count_data[5:8])
counts_sub1_all <- do.call(rbind, count_data[9:12])
counts_sub2_all <- do.call(rbind, count_data[13:16])

# Create column to loop through
counts_ASD_all$loopname <- paste(counts_ASD_all$ROI, counts_ASD_all$hemi, counts_ASD_all$direction)
counts_TC_all$loopname <- paste(counts_TC_all$ROI, counts_TC_all$hemi, counts_TC_all$direction)
counts_sub1_all$loopname <- paste(counts_sub1_all$ROI, counts_sub1_all$hemi, counts_sub1_all$direction)
counts_sub2_all$loopname <- paste(counts_sub2_all$ROI, counts_sub2_all$hemi, counts_sub2_all$direction)

```

Compare ASD vs TC

```{r}
counts_ASD_all$percentage = as.numeric(counts_ASD_all$percentage)
counts_TC_all$percentage = as.numeric(counts_TC_all$percentage)

# Positive
## assumptions normality:
qqnorm(counts_ASD_all$percentage)
qqline(counts_ASD_all$percentage, col = "red")

qqnorm(counts_TC_all$percentage)
qqline(counts_TC_all$percentage, col = "red")

## assumptions equal variance:
var.test(counts_ASD_all$percentage, counts_TC_all$percentage)

wilcox.test(counts_ASD_all$percentage, counts_TC_all$percentage)

```

Compare Subgroups

```{r}
counts_sub1_all$percentage = as.numeric(counts_sub1_all$percentage)
counts_sub2_all$percentage = as.numeric(counts_sub2_all$percentage)

# Positive
## assumptions normality:
qqnorm(counts_sub1_all$percentage)
qqline(counts_sub1_all$percentage, col = "red")

qqnorm(counts_sub2_all$percentage)
qqline(counts_sub2_all$percentage, col = "red")

## assumptions equal variance:
var.test(counts_sub1_all$percentage, counts_sub2_all$percentage)


wilcox.test(counts_sub1_all$percentage, counts_sub2_all$percentage)

```

## mega model

### Prepare data to run the model

```{r}
set.seed(1)

data_megamodel = filter(data_normative_Destrieux, !data_normative_Destrieux$SITE_ID %in% c("ABIDEII-KUL_3", "SBL"))

data_megamodel_ASD = filter(data_megamodel, data_megamodel$DX_GROUP==1)
data_megamodel_TC = filter(data_megamodel, data_megamodel$DX_GROUP==2)


# Find unique sites
unique_sites <- unique(data_megamodel_TC$SITE_ID)

# Initialize empty train and test data frames
data_megamodel_TC_train <- data.frame()
data_megamodel_TC_test <- data.frame()

# Split data by sites
for (site in unique_sites) {
  site_data <- data_megamodel_TC[data_megamodel_TC$SITE_ID == site, ]
  n <- nrow(site_data)
  train_indices <- sample(1:n, floor(0.5 * n))

  site_train <- site_data[train_indices, ]
  site_test <- site_data[-train_indices, ]

  data_megamodel_TC_train <- rbind(data_megamodel_TC_train, site_train)
  data_megamodel_TC_test <- rbind(data_megamodel_TC_test, site_test)
}


data_megamodel_train = data_megamodel_TC_train 
data_megamodel_test = rbind(data_megamodel_ASD, data_megamodel_TC_test)

remove_columns = c("DX_GROUP", "FIQ", "EULER_lh", "EULER_rh", "meanEULER")

data_megamodel_train = data_megamodel_train[, !names(data_megamodel_train) %in% remove_columns]
data_megamodel_test = data_megamodel_test[, !names(data_megamodel_test) %in% remove_columns]

# Change column names so it fits with template

colnames(data_megamodel_train)[1] = "sub_id"
colnames(data_megamodel_train)[2] = "site"
colnames(data_megamodel_train)[3] = "age"
colnames(data_megamodel_train)[4] = "sex"
colnames(data_megamodel_train) = gsub("_and_", "&", colnames(data_megamodel_train))
colnames(data_megamodel_train) = gsub("\\.", "-", colnames(data_megamodel_train))

colnames(data_megamodel_test)[1] = "sub_id"
colnames(data_megamodel_test)[2] = "site"
colnames(data_megamodel_test)[3] = "age"
colnames(data_megamodel_test)[4] = "sex"
colnames(data_megamodel_test) = gsub("_and_", "&", colnames(data_megamodel_test))
colnames(data_megamodel_test) = gsub("\\.", "-", colnames(data_megamodel_test))

# Change data type
data_megamodel_test$sub_id = as.character(data_megamodel_test$sub_id)
data_megamodel_test$age = as.numeric(data_megamodel_test$age)
data_megamodel_test$sex = as.numeric(data_megamodel_test$sex)

data_megamodel_train$sub_id = as.character(data_megamodel_train$sub_id)
data_megamodel_train$age = as.numeric(data_megamodel_train$age)
data_megamodel_train$sex = as.numeric(data_megamodel_train$sex)

for (i in 1:nrow(data_megamodel_test)) {
  if (grepl('ABIDE', data_megamodel_test[i, 'site']) & grepl('_', data_megamodel_test[i, 'site']) & grepl('-', data_megamodel_test[i, 'site'])) {
    site_name <- unlist(strsplit(substring(data_megamodel_test[i, 'site'], first = 2), '-'))[2]
    data_megamodel_test[i, 'site'] <- sub('_\\d$', '', site_name)
  } else if (grepl('ABIDE', data_megamodel_test[i, 'site']) & grepl('_', data_megamodel_test[i, 'site']) & !grepl('-', data_megamodel_test[i, 'site'])) {
    site_name <- unlist(strsplit(substring(data_megamodel_test[i, 'site'], first = 2), '_'))[1]
    data_megamodel_test[i, 'site'] <- sub('_\\d$', '', site_name)
  } else if (grepl('ABIDE', data_megamodel_test[i, 'site']) & grepl('-', data_megamodel_test[i, 'site']) & !grepl('_', data_megamodel_test[i, 'site'])) {
    site_name <- unlist(strsplit(substring(data_megamodel_test[i, 'site'], first = 2), '-'))[1]
    data_megamodel_test[i, 'site'] <- sub('_\\d$', '', site_name)
  }
}


for (i in 1:nrow(data_megamodel_train)) {
  if (grepl('ABIDE', data_megamodel_train[i, 'site']) & grepl('_', data_megamodel_train[i, 'site']) & grepl('-', data_megamodel_train[i, 'site'])) {
    site_name <- unlist(strsplit(substring(data_megamodel_train[i, 'site'], first = 2), '-'))[2]
    data_megamodel_train[i, 'site'] <- sub('_\\d$', '', site_name)
  } else if (grepl('ABIDE', data_megamodel_train[i, 'site']) & grepl('_', data_megamodel_train[i, 'site']) & !grepl('-', data_megamodel_train[i, 'site'])) {
    site_name <- unlist(strsplit(substring(data_megamodel_train[i, 'site'], first = 2), '_'))[1]
    data_megamodel_train[i, 'site'] <- sub('_\\d$', '', site_name)
  } else if (grepl('ABIDE', data_megamodel_train[i, 'site']) & grepl('-', data_megamodel_train[i, 'site']) & !grepl('_', data_megamodel_train[i, 'site'])) {
    site_name <- unlist(strsplit(substring(data_megamodel_train[i, 'site'], first = 2), '-'))[1]
    data_megamodel_train[i, 'site'] <- sub('_\\d$', '', site_name)
  }
}


#Export as csv
write.table(data_megamodel_test, "/Volumes/methlab/Students/Jente/Data/sensitivity analysis/megamodelCSV/data_megamodel_test.csv", sep = ",", dec = ".", row.names = FALSE)

write.table(data_megamodel_train, "/Volumes/methlab/Students/Jente/Data/sensitivity analysis/megamodelCSV/data_megamodel_train.csv", sep = ",", dec = ".",  row.names = FALSE)

```

### Compare deviation scores

Load deviation scores from the mega model

```{r}
data_megamodel <- read.csv("/Volumes/methlab/Students/Jente/Data/sensitivity analysis/megamodelCSV/results/resultsmegamodel.csv")

#Merge with phenotypic dataframe
data_megamodel_subs <- merge(dataforclust, data_megamodel, by = "SUB_ID")

#Also merge with complete dataset so we can combine diagnosis
data_megamodel_all = merge(ABIDE_pheno_clean, data_megamodel, by="SUB_ID")

```

We compare the deviation scores from the normative model between the
subgroups. We will only show and save the plot if the area is
signficiant after FDR correction.

```{r, cache=TRUE}
# make empty dataframe to store results
p_values <- data.frame(matrix(ncol = 7, nrow = 0))
#Change colnames
colnames(p_values) <- c("ROI", "p_value_abs", "p_value_adjusted_abs", "p_value_pos", "p_value_adjusted_pos", "p_value_neg", "p_value_adjusted_neg")

i <- 0
#Loop through each ROI
for (ROI in colnames(data_megamodel_subs)[14:163]) {
  
  i <- i + 1
  p_values[i,1] = ROI
  
  #Save data for each ROI for each cluster
  data_roi <- data_megamodel_subs[c(ROI, "classification_model")]
  data_roi_abs <- data_megamodel_subs[c(ROI, "classification_model")]
  
  # Absolute
  data_roi_abs[, ROI] <- abs(data_roi[, ROI])
  
  data_roi_abs_1 <- filter(data_roi_abs, data_roi_abs$classification_model == 1)
  data_roi_abs_2 <- filter(data_roi_abs, data_roi_abs$classification_model == 2)
  
  #Calculate p-values and save
  p_values[i, 2] <- wilcox.test(as.numeric(data_roi_abs_1[, c(ROI)]), as.numeric(data_roi_abs_2[, c(ROI)]))$p.value
  
  # Prepare for positive and negative
  data_roi1 <- filter(data_roi, data_roi$classification_model == 1)
  data_roi2 <- filter(data_roi, data_roi$classification_model == 2)
  
  # positive
  #Calculate p-values and save
  p_values[i, 4] <- wilcox.test(as.numeric(data_roi1[, c(ROI)][data_roi1[,c(ROI)]>0]), as.numeric(data_roi2[, c(ROI)][data_roi2[,c(ROI)]>0]))$p.value
  
  # negative
  
  #Calculate p-values and save
  p_values[i, 6] <- wilcox.test(as.numeric(data_roi1[, c(ROI)][data_roi1[,c(ROI)]<0]), as.numeric(data_roi2[, c(ROI)][data_roi2[,c(ROI)]<0]))$p.value
}

#Adjust p values for multiple comparison
p_values$p_value_adjusted_abs <- p.adjust(p_values$p_value_abs, method = "fdr")
p_values$p_value_adjusted_pos <- p.adjust(p_values$p_value_pos, method = "fdr")
p_values$p_value_adjusted_neg <- p.adjust(p_values$p_value_neg, method = "fdr")



for (i in 1:150){
  #Plot if ROI is significant, otherwise not and show message about significance.
  if (p_values[i, 3] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))
    
    print(
      ggplot(data_roi, aes(x = "classification_model", y = data_megamodel_subs[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup absolute")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")
          
        )
    )
  }
  
  if (p_values[i, 5] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))
    
    print(
      ggplot(data_roi, aes(x = "classification_model", y = data_megamodel_subs[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup positive")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")
          
        )
    )
  }
  
  if (p_values[i, 7] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))
    
    print(
      ggplot(data_roi, aes(x = "classification_model", y = data_megamodel_subs[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup negative")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")
          
        )
    )
  }
}

```

We compare the deviation scores from the normative model between autism
and TC. We will only show and save the plot if the area is signficiant
after FDR correction.

```{r, cache=TRUE}
# make empty dataframe to store results
p_values_diag <- data.frame(matrix(ncol = 7, nrow = 0))
#Change colnames
colnames(p_values_diag) <-  c("ROI", "p_value_abs", "p_value_adjusted_abs", "p_value_pos", "p_value_adjusted_pos", "p_value_neg", "p_value_adjusted_neg")

i <- 0
#Loop through each ROI
for (ROI in colnames(data_megamodel_all)[16:165]) {
  
  i <- i + 1
  p_values_diag[i,1] = ROI
  
  #Save data for each ROI for each cluster
  data_roi <- data_megamodel_all[c(ROI, "DX_GROUP")]
  data_roi_abs <- data_megamodel_all[c(ROI, "DX_GROUP")]
  
  
  # Absolute
  data_roi_abs[, ROI] <- abs(data_roi[, ROI])
  
  data_roi_abs_ASD <- filter(data_roi_abs, data_roi_abs$DX_GROUP == 1)
  data_roi_abs_TC <- filter(data_roi_abs, data_roi_abs$DX_GROUP == 2)
  
  #Calculate p-values and save
  p_values_diag[i, 2] <- wilcox.test(as.numeric(data_roi_abs_ASD[, c(ROI)]), as.numeric(data_roi_abs_TC[, c(ROI)]))$p.value
  
  # Prepare for positive and negative
  data_roiASD <- filter(data_roi, data_roi$DX_GROUP == 1)
  data_roiTC <- filter(data_roi, data_roi$DX_GROUP == 2)
  
  # positive
  #Calculate p-values and save
  p_values_diag[i, 4] <- wilcox.test(as.numeric(data_roiASD[, c(ROI)][data_roiASD[,c(ROI)]>0]), as.numeric(data_roiTC[, c(ROI)][data_roiTC[,c(ROI)]>0]))$p.value
  
  # negative
  
  #Calculate p-values and save
  p_values_diag[i, 6] <- wilcox.test(as.numeric(data_roiASD[, c(ROI)][data_roiASD[,c(ROI)]<0]), as.numeric(data_roiTC[, c(ROI)][data_roiTC[,c(ROI)]<0]))$p.value
}

#Adjust p values for multiple comparison
p_values_diag$p_value_adjusted_abs <- p.adjust(p_values_diag$p_value_abs, method = "fdr")
p_values_diag$p_value_adjusted_pos <- p.adjust(p_values_diag$p_value_pos, method = "fdr")
p_values_diag$p_value_adjusted_neg <- p.adjust(p_values_diag$p_value_neg, method = "fdr")


data_megamodel_all$DX_GROUP = as.character(data_megamodel_all$DX_GROUP)

i <- 0
for (ROI in colnames(data_megamodel_all)[16:165]){
  
  i <- i + 1
  
  #Plot if ROI is significant, otherwise not and show message about significance.
  if (p_values_diag[i, 3] < 0.05) {
    
    
    plotdata = data_megamodel_all
    plotdata[ROI] = abs(plotdata[ROI])
    
    print("absolute")
    print(p_values_diag[i, 1])
    print(wilcox.test(plotdata[plotdata$DX_GROUP == 1, ROI], plotdata[plotdata$DX_GROUP == 2, ROI]))
    print(p_values_diag[i,3])
    print(median(plotdata[plotdata$DX_GROUP == 1, ROI]))
    print(IQR(plotdata[plotdata$DX_GROUP == 1, ROI]))
    print(median(plotdata[plotdata$DX_GROUP == 2, ROI]))
    print(IQR(plotdata[plotdata$DX_GROUP == 2, ROI]))
    
    print(
      ggplot(plotdata, aes(x = DX_GROUP, y = .data[[ROI]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(ROI, "for TC and Autism Absolute deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
  }
  
  if (p_values_diag[i,5]<0.05){
    plotdata_pos = filter(data_megamodel_all, data_megamodel_all[ROI] > 0)
    
    print("positive")
    print(p_values_diag[i, 1])
    print(wilcox.test(plotdata_pos[plotdata_pos$DX_GROUP == 1, ROI], plotdata_pos[plotdata_pos$DX_GROUP == 2, ROI]))
    print(p_values_diag[i,5])
    print(median(plotdata_pos[plotdata_pos$DX_GROUP == 1, ROI]))
    print(IQR(plotdata_pos[plotdata_pos$DX_GROUP == 1, ROI]))
    print(median(plotdata_pos[plotdata_pos$DX_GROUP == 2, ROI]))
    print(IQR(plotdata_pos[plotdata_pos$DX_GROUP == 2, ROI]))
    
    print(
      ggplot(plotdata_pos, aes(x = DX_GROUP, y = .data[[ROI]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(ROI, "for TC and Autism Positive deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
  }
  
  if (p_values_diag[i,7]<0.05){
    plotdata_neg = filter(data_megamodel_all, data_megamodel_all[ROI] < 0)
    
    print("negative")
    print(p_values_diag[i, 1])
    print(wilcox.test(plotdata_neg[plotdata_neg$DX_GROUP == 1, ROI], plotdata_neg[plotdata_neg$DX_GROUP == 2, ROI]))
    print(p_values_diag[i,7])
    print(median(plotdata_neg[plotdata_neg$DX_GROUP == 1, ROI]))
    print(IQR(plotdata_neg[plotdata_neg$DX_GROUP == 1, ROI]))
    print(median(plotdata_neg[plotdata_neg$DX_GROUP == 2, ROI]))
    print(IQR(plotdata_neg[plotdata_neg$DX_GROUP == 2, ROI]))
    
    print(
      ggplot(plotdata_neg, aes(x = DX_GROUP, y = .data[[ROI]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(ROI, "for TC and Autism Negative deviations")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
  }
}
```

### Atypicality index

Subgroups

```{r}

#Create atypicality index with extreme value statistics 

data_megamodel_subs$atyp_index_abs <- 0
data_megamodel_subs$atyp_index_pos <- 0
data_megamodel_subs$atyp_index_neg <- 0

for (i in 1:nrow(data_megamodel_subs)) {
  subdata <- data_megamodel_subs[i, 14:163]
  absolute_1pct_cutoff <- quantile(abs(subdata), 0.99, na.rm = TRUE)
  positive_1pct_cutoff <- quantile(subdata[subdata>0], 0.99)
  negative_1pct_cutoff <- quantile(subdata[subdata<0], 0.01)
  
  top1_abs <- subdata[abs(subdata) > absolute_1pct_cutoff]
  top1_pos <- subdata[subdata > positive_1pct_cutoff]
  top1_neg <- subdata[subdata < negative_1pct_cutoff]
  
  data_megamodel_subs$atyp_index_abs[i] <- mean(abs(top1_abs), na.rm = TRUE)
  data_megamodel_subs$atyp_index_pos[i] <- mean(top1_pos, na.rm = TRUE)
  data_megamodel_subs$atyp_index_neg[i] <- mean(top1_neg, na.rm = TRUE)
  
}


# Compare subgroups

p_absolute = wilcox.test(data_megamodel_subs$atyp_index_abs[data_megamodel_subs$classification_model==1], data_megamodel_subs$atyp_index_abs[data_megamodel_subs$classification_model==2])

p_positive = wilcox.test(data_megamodel_subs$atyp_index_pos[data_megamodel_subs$classification_model==1],data_megamodel_subs$atyp_index_pos[data_megamodel_subs$classification_model==2])

p_negative = wilcox.test(data_megamodel_subs$atyp_index_neg[data_megamodel_subs$classification_model==1], data_megamodel_subs$atyp_index_neg[data_megamodel_subs$classification_model==2])

p_values = c(p_negative$p.value, p_absolute$p.value, p_negative$p.value)

p.adjust(p_values, method = "fdr")

# Visualize differences
ggplot(data_megamodel_subs, aes(classification_model, fill = classification_model)) +
  geom_boxplot(aes(y = atyp_index_pos, x = "Positive"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = atyp_index_neg, x = "Negative"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = atyp_index_abs, x = "Absolute"), size=0.3, outlier.size=0.3) +
  theme_classic() +
  labs(x = "Atypicality Index", y = "Deviation score", title = "Atypicality Index differences between subgroups in megamodel") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels = c("High-RRB subgroup", "Low-RRB subgroup")
  )

# Descriptives
p_positive
median(data_megamodel_subs$atyp_index_pos[data_megamodel_subs$classification_model==1])
IQR(data_megamodel_subs$atyp_index_pos[data_megamodel_subs$classification_model==1])
median(data_megamodel_subs$atyp_index_pos[data_megamodel_subs$classification_model==2])
IQR(data_megamodel_subs$atyp_index_pos[data_megamodel_subs$classification_model==2])

p_negative
median(data_megamodel_subs$atyp_index_neg[data_megamodel_subs$classification_model==1])
IQR(data_megamodel_subs$atyp_index_neg[data_megamodel_subs$classification_model==1])
median(data_megamodel_subs$atyp_index_neg[data_megamodel_subs$classification_model==2])
IQR(data_megamodel_subs$atyp_index_neg[data_megamodel_subs$classification_model==2])

p_absolute
median(data_megamodel_subs$atyp_index_abs[data_megamodel_subs$classification_model==1])
IQR(data_megamodel_subs$atyp_index_abs[data_megamodel_subs$classification_model==1])
median(data_megamodel_subs$atyp_index_abs[data_megamodel_subs$classification_model==2])
IQR(data_megamodel_subs$atyp_index_abs[data_megamodel_subs$classification_model==2])
```

Autism vs TC

```{r}

#Create atypicality index with extreme value statistics 

data_megamodel_all$atyp_index <- 0

for (i in 1:nrow(data_megamodel_all)) {
  subdata <- data_megamodel_all[i, 16:165]
  absolute_1pct_cutoff <- quantile(abs(subdata), 0.99, na.rm = TRUE)
  positive_1pct_cutoff <- quantile(subdata[subdata>0], 0.99)
  negative_1pct_cutoff <- quantile(subdata[subdata<0], 0.01)
  
  top1_abs <- subdata[abs(subdata) > absolute_1pct_cutoff]
  top1_pos <- subdata[subdata > positive_1pct_cutoff]
  top1_neg <- subdata[subdata < negative_1pct_cutoff]
  
  data_megamodel_all$atyp_index_abs[i] <- mean(abs(top1_abs), na.rm = TRUE)
  data_megamodel_all$atyp_index_pos[i] <- mean(top1_pos, na.rm = TRUE)
  data_megamodel_all$atyp_index_neg[i] <- mean(top1_neg, na.rm = TRUE)
}


# Compare diagnosis

data_megamodel_all$DX_GROUP = as.character(data_megamodel_all$DX_GROUP)



p_absolute = wilcox.test(data_megamodel_all$atyp_index_abs[data_megamodel_all$DX_GROUP==1], data_megamodel_all$atyp_index_abs[data_megamodel_all$DX_GROUP==2])

p_positive = wilcox.test(data_megamodel_all$atyp_index_pos[data_megamodel_all$DX_GROUP==1], data_megamodel_all$atyp_index_pos[data_megamodel_all$DX_GROUP==2])

p_negative = wilcox.test(data_megamodel_all$atyp_index_neg[data_megamodel_all$DX_GROUP==1], data_megamodel_all$atyp_index_neg[data_megamodel_all$DX_GROUP==2])

p_values = c(p_positive$p.value, p_absolute$p.value, p_negative$p.value)

p.adjust(p_values, method="fdr")




# Visualize differences
ggplot(data_megamodel_all, aes(DX_GROUP, fill = DX_GROUP)) +
  geom_boxplot(aes(y = atyp_index_pos, x = "Positive"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = atyp_index_neg, x = "Negative"), size=0.3, outlier.size=0.3) +
  geom_boxplot(aes(y = atyp_index_abs, x = "Absolute"), size=0.3, outlier.size=0.3) +
  theme_classic() +
  labs(x = "Atypicality Index", y = "Deviation score", title = "Atypicality Index differences between TC and autism in megamodel") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels = c("Autism", "TC")
  )

# Descriptives
p_positive
median(data_megamodel_all$atyp_index_pos[data_megamodel_all$DX_GROUP==1])
IQR(data_megamodel_all$atyp_index_pos[data_megamodel_all$DX_GROUP==1])
median(data_megamodel_all$atyp_index_pos[data_megamodel_all$DX_GROUP==2])
IQR(data_megamodel_all$atyp_index_pos[data_megamodel_all$DX_GROUP==2])

p_negative
median(data_megamodel_all$atyp_index_neg[data_megamodel_all$DX_GROUP==1])
IQR(data_megamodel_all$atyp_index_neg[data_megamodel_all$DX_GROUP==1])
median(data_megamodel_all$atyp_index_neg[data_megamodel_all$DX_GROUP==2])
IQR(data_megamodel_all$atyp_index_neg[data_megamodel_all$DX_GROUP==2])

p_absolute
median(data_megamodel_all$atyp_index_abs[data_megamodel_all$DX_GROUP==1])
IQR(data_megamodel_all$atyp_index_abs[data_megamodel_all$DX_GROUP==1])
median(data_megamodel_all$atyp_index_abs[data_megamodel_all$DX_GROUP==2])
IQR(data_megamodel_all$atyp_index_abs[data_megamodel_all$DX_GROUP==2])
```

### Count significant deviations

Subgroups

```{r}

data_megamodel_subs$count = 0


for (i in 1:nrow(data_megamodel_subs)){ # Loop through each participant
  
  subdata <- data_megamodel_subs[i,]
  
  for (ROI in colnames(data_megamodel_subs)[14:163]){ # Loop through each ROI
    
    p_value = pnorm(data_megamodel_subs[i,ROI], lower.tail=FALSE) # determine p_value for each participant and each ROI

    if (p_value < 0.005){ # If significant, add 1 to the number of significant regions
      data_megamodel_subs$count[i] = data_megamodel_subs$count[i] + 1
    }
  }
}

# Compare number of significant regions
wilcox.test(data_megamodel_subs$count[data_megamodel_subs$classification_model==1], data_megamodel_subs$count[data_megamodel_subs$classification_model==2]) 

```

Autism vs TC

```{r}

data_megamodel_all$count = 0

for (i in 1:nrow(data_megamodel_all)){# Loop through each participant
  
  subdata <- data_megamodel_all[i,]
  
  for (ROI in colnames(data_megamodel_all)[16:165]){# Loop through each ROI
    
    p_value = pnorm(data_megamodel_all[i,ROI], lower.tail=FALSE)# determine p_value for each participant and each ROI
    
    if (p_value < 0.005){
      data_megamodel_all$count[i] = data_megamodel_all$count[i] + 1
    }
  }
}

# Compare number of significant regions
wilcox.test(data_megamodel_all$count[data_megamodel_all$DX_GROUP==1], data_megamodel_all$count[data_megamodel_all$DX_GROUP==2])

```

## Remove all participants over 30 years old

Filter

```{r}
dataforclust_age  <- filter(dataforclust, dataforclust$AGE_AT_SCAN < 30)
```

### Cluster

perform the GLM and store residuals.

```{r, cache=TRUE}
glm_test <- glm(dataforclust_age$ADOS_COMM_zscore ~ dataforclust_age$AGE_AT_SCAN + dataforclust_age$SITE_ID + dataforclust_age$FIQ + dataforclust_age$ADOS_MODULE + dataforclust_age$ADOS_SOCIAL_zscore + dataforclust_age$ADOS_STEREO_BEHAV_zscore)
dataforclust_age$ADOS_COMM_zscore_res <- glm_test$residuals

glm_test <- glm(dataforclust_age$ADOS_SOCIAL_zscore ~ dataforclust_age$AGE_AT_SCAN + dataforclust_age$SITE_ID + dataforclust_age$FIQ + dataforclust_age$ADOS_MODULE + dataforclust_age$ADOS_COMM_zscore + dataforclust_age$ADOS_STEREO_BEHAV_zscore)
dataforclust_age$ADOS_SOCIAL_zscore_res <- glm_test$residuals

glm_test <- glm(dataforclust_age$ADOS_STEREO_BEHAV_zscore ~ dataforclust_age$AGE_AT_SCAN + dataforclust_age$SITE_ID + dataforclust_age$FIQ + dataforclust_age$ADOS_MODULE + dataforclust_age$ADOS_COMM_zscore + dataforclust_age$ADOS_SOCIAL_zscore)
dataforclust_age$ADOS_STEREO_BEHAV_zscore_res <- glm_test$residuals
```

### Perform model-based clustering

Here we perform the model-based clustering based on the clinical
subscores.

```{r, fig.height=5, fig.width=5, cache=TRUE}
# use cluster algorithm
clust_test_age <- Mclust(dataforclust_age[, c("ADOS_COMM_zscore_res", "ADOS_SOCIAL_zscore_res", "ADOS_STEREO_BEHAV_zscore_res")], verbose = FALSE)

# Save clustering result 
dataforclust_age$classification_model <- as.character(clust_test_age$classification)
```

```{r, cache=TRUE, fig.height=7, fig.width=10}
# First we have to make a new dataframe in a long format instead of wide
newdata_age1 <- data.frame(dataforclust_age$SUB_ID, dataforclust_age$classification_model, dataforclust_age$ADOS_COMM_zscore_res)
colnames(newdata_age1) <- c("SUB_ID", "Group", "Score")
newdata_age1$scoretype <- "AODS_COMM_zscore_res"

newdata_age2 <- data.frame(dataforclust_age$SUB_ID, dataforclust_age$classification_model, dataforclust_age$ADOS_SOCIAL_zscore_res)
colnames(newdata_age2) <- c("SUB_ID", "Group", "Score")
newdata_age2$scoretype <- "AODS_SOCIAL_zscore_res"

newdata_age3 <- data.frame(dataforclust_age$SUB_ID, dataforclust_age$classification_model, dataforclust_age$ADOS_STEREO_BEHAV_zscore_res)
colnames(newdata_age3) <- c("SUB_ID", "Group", "Score")
newdata_age3$scoretype <- "AODS_STEREO_BEHAV_zscore_res"

dataforplot_age <- rbind(newdata_age1, newdata_age2, newdata_age3)

ggplot(dataforplot_age, aes(x = scoretype, y = Score, fill = Group)) +
  geom_boxplot(position = position_dodge(width = 0.8), width = 0.6) +
  theme_classic() +
  labs(x = "Subscores", y = "Residuals z-score", title = "Residuals of z-score for each subscore") +
  scale_x_discrete(labels = c("Communication", "Social", "RRBs")) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Subgroup",
                    labels = c("Subgroup 1", "Subgroup 2")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12), text = element_text(size=18)) 

```

### Brain data

Filter out age

```{r}
data_normative_Destrieux_age  <- filter(data_normative_Destrieux, data_normative_Destrieux$AGE_AT_SCAN < 30)

```

Export dataset for normative model

```{r}
write.table(data_normative_Destrieux_age, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/Data/Data_normative_Destrieux.txt", append = FALSE, sep = ",", dec = ".", col.names = TRUE)
```

### Normative model

```{r}
Deviation_scores_age <- read_csv("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/blr/powell/outputs/Deviation_scores.csv", col_types = cols(...1 = col_skip()))

# Merge with clustering results so we can compare between groups.

Brain_data_results_age <- merge(dataforclust_age, Deviation_scores_age, by = "SUB_ID") # Data subgroups

#Also merge with complete dataset so we can compare diagnosis
Brain_data_results_age_all = merge(ABIDE_pheno_clean, Deviation_scores_age, by="SUB_ID") # Data all

```

We compare the deviation scores from the normative model between the
subgroups. We will only show and save the plot if the area is
signficiant after FDR correction.

```{r, cache=TRUE}
# make empty dataframe to store results
p_values <- data.frame(matrix(ncol = 3, nrow = 0))
#Change colnames
colnames(p_values) <- c("ROI", "p_value", "p_value_adjusted")

i <- 0
#Loop through each ROI
for (ROI in colnames(Brain_data_results_age)[14:163]) {
  
  i <- i + 1
  
  #Save data for each ROI for each cluster
  data_roi <- Brain_data_results_age[c(ROI, "classification_model")]
  data_roi[, ROI] <- abs(data_roi[, ROI])
  data_roi_1 <- filter(data_roi, data_roi$classification_model == 1)
  data_roi_2 <- filter(data_roi, data_roi$classification_model == 2)
  
  p_values[i,1] = ROI
  #Calculate p-values and save
  p_values[i, 2] <- wilcox.test(as.numeric(data_roi_1[, c(ROI)]), as.numeric(data_roi_2[, c(ROI)]))$p.value
}

#Adjust p values for multiple comparison
p_values$p_value_adjusted <- p.adjust(p_values$p_value, method = "fdr")


for (i in 1:150){
  #Plot if ROI is significant, otherwise not and show message about significance.
  if (p_values[i, 3] < 0.05) {
    message(green(i, "is significant. P_value is:", p_values[i, 3]))
    
    print(
      ggplot(data_roi, aes(x = "classification_model", y = Brain_data_results_age[,p_values$ROI[i]])) +
        geom_boxplot(aes(fill = classification_model)) +
        theme_classic() +
        labs(x = "Classification", y = paste(p_values$ROI[i], "deviation score"), title = paste(p_values$ROI[i], "for each Subgroup")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroup", labels =
            c("Subgroup 1", "Subgroup 2")
          
        )
    )
  }
}

```

We compare the deviation scores from the normative model between autism
and TC. We will only show and save the plot if the area is signficiant
after FDR correction.

```{r, cache=TRUE}
# make empty dataframe to store results
p_values_diag <- data.frame(matrix(ncol = 3, nrow = 0))
#Change colnames
colnames(p_values_diag) <- c("ROI", "p_value", "p_value_adjusted")

i <- 0
#Loop through each ROI
for (ROI in colnames(Brain_data_results_age_all)[16:165]) {
  
  i <- i + 1
  
  #Save data for each ROI for each cluster
  data_roi <- Brain_data_results_age_all[c(ROI, "DX_GROUP")]
  data_roi$DX_GROUP = as.character(data_roi$DX_GROUP)
  data_roi[, ROI] <- abs(data_roi[, ROI])
  data_roi_1 <- filter(data_roi, data_roi$DX_GROUP == 1)
  data_roi_2 <- filter(data_roi, data_roi$DX_GROUP == 2)
  
  p_values_diag[i,1] = ROI
  #Calculate p-values and save
  p_values_diag[i, 2] <- wilcox.test(as.numeric(data_roi_1[, c(ROI)]), as.numeric(data_roi_2[, c(ROI)]))$p.value
}

#Adjust p values for multiple comparison
p_values_diag$p_value_adjusted <- p.adjust(p_values_diag$p_value, method = "fdr")

for (i in 1:150){
  #Plot if ROI is significant, otherwise not and show message about significance.
  if (p_values_diag[i, 3] < 0.05) {
    message(green(p_values_diag$ROI[i], "is significant. P_value is:", p_values_diag[i, 3]))
    
    print(
      ggplot(data_roi, aes(x = DX_GROUP, y = Brain_data_results_age_all[,p_values_diag$ROI[i]])) +
        geom_boxplot(aes(fill = DX_GROUP)) +
        theme_classic() +
        labs(x = "Group", y = paste(p_values_diag$ROI[i], "deviation score"), title = paste(p_values_diag$ROI[i], "for TC and Autism")) +
        theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
        geom_jitter(size = 0.1) +
        scale_fill_manual(
          values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
            c("Autism", "TC")
        )
    )
  }
}
```

Atypicality index with extreme value statistics Load data from normative
model in long format

```{r}
Z_df_age <- read.csv("/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/Z_df.csv")

# Make column with absolute values of CT
Z_df_age$CTabs <- abs(Z_df_age$CT)
```

Extreme value statistics

```{r}
# Find maximum value for the 1% maximum or minimum of each block (i.e., subject)
Z_max_age <- data.frame(matrix(ncol = 4, nrow = length(unique(Z_df_age$SUB_ID))))
colnames(Z_max_age) <- c("SUB_ID", "positive_max", "negative_max", "absolute_max")

i <- 0
for (sub in unique(Z_df_age$SUB_ID)) { # Loop through each subject
  i <- i + 1
  
  Z_max_age[i, 1] <- sub
  
  positive_1pct_cutoff <- quantile(Z_df_age$CT[Z_df_age$SUB_ID == sub], 0.99, na.rm = TRUE)
  negative_1pct_cutoff <- quantile(Z_df_age$CT[Z_df_age$SUB_ID == sub], 0.01, na.rm = TRUE)
  absolute_1pct_cutoff <- quantile(Z_df_age$CTabs[Z_df_age$SUB_ID == sub], 0.99, na.rm = TRUE)
  
  Z_sub <- Z_df_age$CT[Z_df_age$SUB_ID == sub]
  Z_sub_abs <- Z_df_age$CTabs[Z_df_age$SUB_ID == sub]
  
  Z_max_age[i, 2] <- mean(Z_sub[Z_sub > positive_1pct_cutoff])
  Z_max_age[i, 3] <- mean(Z_sub[Z_sub < negative_1pct_cutoff])
  Z_max_age[i, 4] <- mean(Z_sub_abs[Z_sub_abs > absolute_1pct_cutoff])
}
```

Split into TC and ASD so we can compare the Atypicality index between
these groups.

```{r, cache=TRUE}
Z_max_age_ASD <- filter(Z_max_age, Z_max_age$SUB_ID %in% ABIDE_pheno_clean$SUB_ID[ABIDE_pheno_clean$DX_GROUP == 1])
Z_max_age_TC <- filter(Z_max_age, Z_max_age$SUB_ID %in% ABIDE_pheno_clean$SUB_ID[ABIDE_pheno_clean$DX_GROUP == 2])

# also make a column which group for the plots.
Z_max_age_ASD$group <- "ASD"
Z_max_age_TC$group <- "TC"

Z_max_age_diagnosis_plot <- rbind(Z_max_age_ASD, Z_max_age_TC)
```

Compare these Atypicality indexes between autism and TC

```{r, cache=TRUE}
# Positive
## assumptions normality:
qqnorm(Z_max_age_ASD$positive_max)
qqline(Z_max_age_ASD$positive_max, col = "red")

qqnorm(Z_max_age_TC$positive_max)
qqline(Z_max_age_TC$positive_max, col = "red")

## assumptions equal variance:
var.test(Z_max_age_ASD$positive_max, Z_max_age_TC$positive_max)

t_test_positive_age <- wilcox.test(Z_max_age_ASD$positive_max, Z_max_age_TC$positive_max)

# Negative
## assumptions normality:
qqnorm(Z_max_age_ASD$negative_max)
qqline(Z_max_age_ASD$negative_max, col = "red")

qqnorm(Z_max_age_TC$negative_max)
qqline(Z_max_age_TC$negative_max, col = "red")

## assumptions equal variance:
var.test(Z_max_age_ASD$negative_max, Z_max_age_TC$negative_max)

t_test_negative_age <- wilcox.test(Z_max_age_ASD$negative_max, Z_max_age_TC$negative_max)

# Absolute
## assumptions normality:
qqnorm(Z_max_age_ASD$absolute_max)
qqline(Z_max_age_ASD$absolute_max, col = "red")

qqnorm(Z_max_age_TC$absolute_max)
qqline(Z_max_age_TC$absolute_max, col = "red")

## assumptions equal variance:
var.test(Z_max_age_ASD$absolute_max, Z_max_age_TC$absolute_max)

t_test_absolute_age <- wilcox.test(Z_max_age_ASD$absolute_max, Z_max_age_TC$absolute_max)

# Multiple comparison correction
p_values_tests = c(t_test_positive_age$p.value, t_test_negative_age$p.value, t_test_absolute_age$p.value)
p.adjust(p_values_tests, method="fdr")

```

Visualize the differences

```{r}
ggplot(Z_max_age_diagnosis_plot, aes_string(x = "group", y = "positive_max")) +
  geom_boxplot(aes(fill = group)) +
  theme_classic() +
  labs(x = "Group", y = "Atypicality index positive deviations", title = "Positive Atypicality index differences between TC and Autism") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
      c("Autism", "TC")
  )


ggplot(Z_max_age_diagnosis_plot, aes_string(x = "group", y = "negative_max")) +
  geom_boxplot(aes(fill = group)) +
  theme_classic() +
  labs(x = "Group", y = "Atypicality index negative deviations", title = "Negative Atypicality index differences between TC and Autism") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
      c("Autism", "TC")
  )


ggplot(Z_max_age_diagnosis_plot, aes_string(x = "group", y = "absolute_max")) +
  geom_boxplot(aes(fill = group)) +
  theme_classic() +
  labs(x = "Group", y = "Atypicality index absolute deviations", title = "Absolute Atypicality index differences between TC and Autism") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Group", labels =
      c("Autism", "TC")
  )

```

Split into ASD subgroups so we can compare the Atypicality index between
these groups.

```{r}
#Split dataframes into subtypes
Z_max_age_clust1 <- filter(Z_max_age, Z_max_age$SUB_ID %in% dataforclust$SUB_ID[dataforclust$classification_model == 1])
Z_max_age_clust2 <- filter(Z_max_age, Z_max_age$SUB_ID %in% dataforclust$SUB_ID[dataforclust$classification_model == 2])

# also make a column which group for the plots.
Z_max_age_clust1$group <- "clust1"
Z_max_age_clust2$group <- "clust2"

#Bind the dataframes together
Z_max_age_plot <- rbind(Z_max_age_clust1, Z_max_age_clust2)
```

Compare these Atypicality indexes between subgroups

```{r}
# Positive
## assumptions normality:
qqnorm(Z_max_age_clust1$positive_max)
qqline(Z_max_age_clust1$positive_max, col = "red")

qqnorm(Z_max_age_clust2$positive_max)
qqline(Z_max_age_clust2$positive_max, col = "red")

## assumptions equal variance:
var.test(Z_max_age_clust1$positive_max, Z_max_age_clust2$positive_max)

t_test_positive_age <- wilcox.test(Z_max_age_clust1$positive_max, Z_max_age_clust2$positive_max)

# Negative
## assumptions normality:
qqnorm(Z_max_age_clust1$negative_max)
qqline(Z_max_age_clust1$negative_max, col = "red")

qqnorm(Z_max_age_clust2$negative_max)
qqline(Z_max_age_clust2$negative_max, col = "red")

## assumptions equal variance:
var.test(Z_max_age_clust1$negative_max, Z_max_age_clust2$negative_max)

t_test_negative_age <- wilcox.test(Z_max_age_clust1$negative_max, Z_max_age_clust2$negative_max)

# Absolute
## assumptions normality:
qqnorm(Z_max_age_clust1$absolute_max)
qqline(Z_max_age_clust1$absolute_max, col = "red")

qqnorm(Z_max_age_clust2$absolute_max)
qqline(Z_max_age_clust2$absolute_max, col = "red")

## assumptions equal variance:
var.test(Z_max_age_clust1$absolute_max, Z_max_age_clust2$absolute_max)

t_test_absolute_age <- wilcox.test(Z_max_age_clust1$absolute_max, Z_max_age_clust2$absolute_max)

# Multiple comparison correction
p_values_testsub = c(t_test_positive_age$p.value, t_test_negative_age$p.value, t_test_absolute_age$p.value)
p.adjust(p_values_testsub, method="fdr")

```

Visualize the abornmaility index

```{r}
ggplot(Z_max_age_plot, aes_string(x = "group", y = "positive_max")) +
  geom_boxplot(aes(fill = group)) +
  theme_classic() +
  labs(x = "Subgroup", y = "Atypicality index positive deviations", title = "Positive Atypicality index for each subgroup") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroups", labels =
      c("Subgroup 1", "Subgroup 2")
  )



ggplot(Z_max_age_plot, aes_string(x = "group", y = "negative_max")) +
  geom_boxplot(aes(fill = group)) +
  theme_classic() +
  labs(x = "Subgroup", y = "Atypicality index negative deviations", title = "Negative Atypicality index for each subgroup") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroups", labels =
      c("Subgroup 1", "Subgroup 2")
  )


ggplot(Z_max_age_plot, aes_string(x = "group", y = "absolute_max")) +
  geom_boxplot(aes(fill = group)) +
  theme_classic() +
  labs(x = "Subgroup", y = "Atypicality index absolute deviations", title = "Absolute Atypicality index for each subgroup") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(
    values = c("#5b78e2", "#b30d2e", "#a82393"), name = "Subgroups", labels =
      c("Subgroup 1", "Subgroup 2")
  )

```

P-values for thresholding

For the following analyses and visualisation in python we use a fixed
threshold so we need the p_values. Then for the sensitivity analysis we
also use a individual threshold with FDR correction so we also calculate
the FDR corrected p values.

```{r}
#Calculate p values for each Z-score under a normal distribution
Z_df_age$pvalue <- pnorm(Z_df_age$CTabs, lower.tail = FALSE)

#Perform FDR correction for each participant separately
Z_df_age <- Z_df_age %>%
  group_by(SUB_ID) %>%
  mutate(pvalue_fdr = p.adjust(pvalue, method = "fdr"))
```

Test differences in count significant deviations between groups

Count the number of significant deviations for each participant and
compare this between participants.

```{r}
# Count the number of significant areas
counts_age <- data.frame(matrix(ncol = 0, nrow = length(unique(Z_df_age$SUB_ID))))
counts_age$SUB_ID <- unique(Z_df_age$SUB_ID)

counts_age <- Z_df_age %>%
  group_by(SUB_ID) %>%
  summarise(counts_age = sum(pvalue < 0.005))

# Merge back with dataframe so we have the information about the groups.
## Compare TC with autism

counts_age_all <- merge(counts_age, ABIDE_pheno_clean, by = "SUB_ID")

# Change diagnosis to character instead of numeric
counts_age_all$DX_GROUP <- as.character(counts_age_all$DX_GROUP)

## Test assumptions
qqnorm(counts_age_all$counts_age)
qqline(counts_age_all$counts_age, col = "red")

wilcox.test(counts_age_all$counts_age[counts_age_all$DX_GROUP == 1], counts_age_all$counts_age[counts_age_all$DX_GROUP == 2])

## Visualize
ggplot(counts_age_all, aes_string(x = "DX_GROUP", y = "counts_age")) +
  geom_boxplot(aes(fill = DX_GROUP)) +
  theme_classic() +
  labs(x = "Group", y = "Count deviations", title = "Count deviations differences between TC and Autism") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Group")



## Compare between subgroups
counts_age_ASD <- merge(counts_age, dataforclust, by = "SUB_ID")

## Test assumptions
qqnorm(counts_age_ASD$counts_age)
qqline(counts_age_ASD$counts_age, col = "red")

wilcox.test(counts_age_ASD$counts_age[counts_age_ASD$classification_model == 1], counts_age_ASD$counts_age[counts_age_ASD$classification_model == 2])

## Visualize
ggplot(counts_age_ASD, aes_string(x = "classification_model", y = "counts_age")) +
  geom_boxplot(aes(fill = classification_model)) +
  theme_classic() +
  labs(x = "Subgroup", y = "Count deviations", title = "Count deviations differences between defined subgroups") +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  geom_jitter(size = 0.1) +
  scale_fill_manual(values = c("#5b78e2", "#b30d2e"), name = "Subgroups")





```

Save data so we can plot in python

```{r}
write.table(Z_df_age, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/P_df.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)

```

We want to get brain maps for the different subgroups seperately. So
save the data for each subgroup seperately so it's easy to handle in
python.

```{r}
subs_1 <- dataforclust$SUB_ID[dataforclust$classification_model == 1]
subs_2 <- dataforclust$SUB_ID[dataforclust$classification_model == 2]

Z_df_age_1 <- subset(Z_df_age, Z_df_age$SUB_ID %in% subs_1)
Z_df_age_2 <- subset(Z_df_age, Z_df_age$SUB_ID %in% subs_2)

write.table(Z_df_age_1, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/Z_df_subtype1.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)
write.table(Z_df_age_2, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/Z_df_subtype2.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)
```

Prepare data for plots python

```{r}
ind_FDR_age = Z_df_age
ind_FDR_age$CT[ind_FDR_age$pvalue_fdr > 0.05] <- 0 # When the individual FDR p-value is higher than 0.05, we set the CT to 0 so we can use a threhold of >0 for the brain maps.

write.table(ind_FDR_age, "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/individual_FDR.csv", append = FALSE, sep = ",", dec = ".", col.names = TRUE)

```

Statistics overlap maps

Prepare data We need to work with the Z_df_age file since those contain
the information about significance. However, we need a wide format
instead of a long format so we can loop through the ROIs and count all
parcitipants together. We already did this in python so we'll load the
data and use that.

```{r}
# Create a function to read and process the data
read_data <- function(file_path, hemi, direction) {
  data <- read.csv(file_path)
  data$hemi <- hemi
  data$direction <- direction
  data
}

# Define the file paths and corresponding labels
file_paths <- c(
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_left_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_right_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_left_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_right_z2_ASD.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_left_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_right_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_left_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_right_z2_TC.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_left_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_right_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_left_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_right_z2_1.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_left_z2_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/positive_right_z2_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_left_z2_2.csv",
  "/Volumes/methlab/Students/Jente/Scripts_ASD_analysis_final/python_scripts/ASD_model_age<30/results/negative_right_z2_2.csv"
)

labels <- c(
  "ASD_left_positive", "ASD_right_positive", "ASD_left_negative", "ASD_right_negative",
  "TC_left_positive", "TC_right_positive", "TC_left_negative", "TC_right_negative",
  "sub1_left_positive", "sub1_right_positive", "sub1_left_negative", "sub1_right_negative",
  "sub2_left_positive", "sub2_right_positive", "sub2_left_negative", "sub2_right_negative"
)

# Initialize empty lists
count_data_age <- vector("list", length(file_paths))
all_data <- list()

# Read and process the data
for (i in seq_along(file_paths)) {
  file_path <- file_paths[i]
  label <- labels[i]
  hemi <- ifelse(grepl("left", label), "left", "right")
  direction <- ifelse(grepl("positive", label), "positive", "negative")
  
  count_data_age[[i]] <- read_data(file_path, hemi, direction)
  
  # Combine datasets into a single list
  all_data[[label]] <- count_data_age[[i]]
}

# Combine all datasets into one for each group
counts_age_ASD_all <- do.call(rbind, count_data_age[1:4])
counts_age_TC_all <- do.call(rbind, count_data_age[5:8])
counts_age_sub1_all <- do.call(rbind, count_data_age[9:12])
counts_age_sub2_all <- do.call(rbind, count_data_age[13:16])

# Create column to loop through
counts_age_ASD_all$loopname <- paste(counts_age_ASD_all$ROI, counts_age_ASD_all$hemi, counts_age_ASD_all$direction)
counts_age_TC_all$loopname <- paste(counts_age_TC_all$ROI, counts_age_TC_all$hemi, counts_age_TC_all$direction)
counts_age_sub1_all$loopname <- paste(counts_age_sub1_all$ROI, counts_age_sub1_all$hemi, counts_age_sub1_all$direction)
counts_age_sub2_all$loopname <- paste(counts_age_sub2_all$ROI, counts_age_sub2_all$hemi, counts_age_sub2_all$direction)

```

Compare ASD vs TC

```{r}
counts_age_ASD_all$percentage = as.numeric(counts_age_ASD_all$percentage)
counts_age_TC_all$percentage = as.numeric(counts_age_TC_all$percentage)

# Positive
## assumptions normality:
qqnorm(counts_age_ASD_all$percentage)
qqline(counts_age_ASD_all$percentage, col = "red")

qqnorm(counts_age_TC_all$percentage)
qqline(counts_age_TC_all$percentage, col = "red")

## assumptions equal variance:
var.test(counts_age_ASD_all$percentage, counts_age_TC_all$percentage)

wilcox.test(counts_age_ASD_all$percentage, counts_age_TC_all$percentage)

```

Compare Subgroups

```{r}
counts_age_sub1_all$percentage = as.numeric(counts_age_sub1_all$percentage)
counts_age_sub2_all$percentage = as.numeric(counts_age_sub2_all$percentage)

# Positive
## assumptions normality:
qqnorm(counts_age_sub1_all$percentage)
qqline(counts_age_sub1_all$percentage, col = "red")

qqnorm(counts_age_sub2_all$percentage)
qqline(counts_age_sub2_all$percentage, col = "red")

## assumptions equal variance:
var.test(counts_age_sub1_all$percentage, counts_age_sub2_all$percentage)


wilcox.test(counts_age_sub1_all$percentage, counts_age_sub2_all$percentage)

```
